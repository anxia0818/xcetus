import{a7 as Q}from"./entry.127064e0.js";import{u as V,T as D,e as z,m as H}from"./pool.835fa2a4.js";import{D as a}from"./decimal.0bdeb344.js";import{c as W}from"./sha256.dd43047d.js";const io=Q("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return V()}},actions:{async getFarmsPoolList(){this.farmsPoolListLoading=!0;try{const{data:b}=await fetch(`${W.Sui.api}/v2/sui/swap/count`).then(t=>t.json()),d=b.pools.filter(t=>t.stable_farming);console.log(d,"#farmsPoolsfarmsPools");const m=d.map(t=>{let O=0;console.log(t,"#farmsPool");const U=t.coin_a.decimals,f=t.coin_b.decimals,n=D.tickIndexToPrice(t.stable_farming.effective_tick_lower,U,f).toString(),c=D.tickIndexToPrice(t.stable_farming.effective_tick_upper,U,f).toString(),l=t.stable_farming.stable_rewarder.map(r=>(O+=Number(r.amount_second),{emission_per_day:new a(r.amount_second).mul(60*60*24),reward_coin:r.coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":r.coin,symbol:r.symbol,allocate_point:Number(r.amount_second)>0?1:0}));return console.log(O,t,"##totalAllocatePoint"),{...t,clmm_pool_id:t.swap_account,effective_tick_lower:t.stable_farming.effective_tick_lower,effective_tick_upper:t.stable_farming.effective_tick_upper,fee:t.fee*100+"%",id:t.stable_farming.stable_farming_pool,rewarders:l,status:O>0?"Live":"Ended",minPrice:n,maxPrice:c,coinA:t.coin_a,coinB:t.coin_b,stableFarmingApr:t.stable_farming&&t.stable_farming.apr*100}});this.farmsPoolList=m,this.farmsPoolObj=Object.fromEntries(m.map(t=>[t.clmm_pool_id,{...t,address:t.clmm_pool_id}])),this.farmsPoolListLoading=!1,console.log(d,m,"farmsPools####")}catch(b){console.log("getFarmsPoolList error:",b);const m=await z("Sui").getLpList(),t=Object.fromEntries(m.map((n,c)=>[n.address,n]));console.log(t,"cmmLpObj##");const U=await H("Sui").getFramsPoolList();console.log("getFarmsPoolList:",U);const f=U.map(n=>{const c=t[n.clmm_pool_id];let l=0;const{tokensObj:r}=this.getPoolStore,P=n.rewarders.map(e=>{const o=e.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":e.reward_coin,u=r[o].decimals,S=r[o].symbol;l=l+Number(e.allocate_point);const _=new a(e.allocate_point).div(new a(e.total_allocate_point));return{...e,reward_coin:o,emission_per_day:Number(e.allocate_point)>0?new a(e.emission_per_second).mul(_).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,u)).toString():"0",symbol:S}}),w=c.coinA.decimals,p=c.coinB.decimals,s=D.tickIndexToPrice(n.effective_tick_lower,w,p).toString(),i=D.tickIndexToPrice(n.effective_tick_upper,w,p).toString();return console.log(l,"allocatePoint##"),{...n,minPrice:s,maxPrice:i,fee:c.fee*100+"%",coinA:c.coinA,coinB:c.coinB,rewarders:P,status:l>0?"Live":"Ended",stable_farming:{apr:0,tvl:0},coin_a:c.coinA,coin_b:c.coinB}});console.log("getFarmsPoolList",f),this.farmsPoolList=f,this.farmsPoolObj=Object.fromEntries(f.map(n=>[n.clmm_pool_id,{...n,address:n.clmm_pool_id}])),this.cmmPoolInfoObj=t,this.farmsPoolListLoading=!1}},async getPositionByPool(b,d,m){var s,i;this.farmsLoadingObj[d]=!0;const t=z("Sui"),O=H("Sui");console.log(b,d,"#account, poolAddress");const f=(await O.getOwnedFramsPositionNFTList(!0)).filter(e=>e.clmm_pool_id==d),n=await t.getPositionList(b,{address:{address:d}})||[],c=f.concat(n);console.log(f,n,"###farmingPositionList"),console.log(c,"###positionGroup");const l={},r={},P=[];for(let e=0;e<c.length;e++){const o=c[e],u=this.farmsPoolObj[o.clmm_pool_id||o.pool];console.log(u,"##poolInfo");const S=u.coinA.decimals,_=u.coinB.decimals;let T,L;o.tick_lower_index==t.TickUtil.getMinIndex(Number(u.tick_spacing))?T="0":T=t.TickMath.tickIndexToPrice(Number(o.tick_lower_index),S,_).toString(),o.tick_upper_index==t.TickUtil.getMaxIndex(Number(u.tick_spacing))?L="∞":L=t.TickMath.tickIndexToPrice(Number(o.tick_upper_index),S,_).toString(),console.log(o,"#position.clmm_pool_id");let j;const N=await t.getPool(o.clmm_pool_id||o.pool),R=D.sqrtPriceX64ToPrice(N.current_sqrt_price,S,_).toString();Number(R)>=Number(T)&&(L==="∞"||Number(R)<=Number(L))?j="Active":(Number(R)>Number(L)||Number(R)<Number(T))&&(j="Inactive");const k=t.getCoinAmountFromLiquidity({pool:N,position:o,roundUp:!1}),{RATES:x,tokensObj:F}=this.getPoolStore;console.log(x,"##cmmPoolStore");const B=((s=x[u.coin_a.address])==null?void 0:s.price)||"",v=((i=x[u.coin_a.address])==null?void 0:i.price)||"",I=new a(k.coinaAmount).div(Math.pow(10,S)),E=new a(k.coinbAmount).div(Math.pow(10,_)),G=new a(k.coinaAmount).div(Math.pow(10,S)).mul(B),M=new a(k.coinbAmount).div(Math.pow(10,_)).mul(v);let h=new a(0);o.rewards&&o.rewards.length>0?o.rewards=o.rewards.map(g=>{var J;console.log(g,o,"reward##171");const X=g.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":g.rewarder_type,$=F[X];console.log(F,"##tokensObj");const A=((J=x[X])==null?void 0:J.price)||0,y=new a(g.rewarder_amount).div(new a(Math.pow(10,$.decimals)));console.log(y,A,"amount,rewardPrice");const q=y.mul(new a(A));return console.log(q.toString(),"rewarderAmountUsd"),r[o.clmm_pool_id]&&r[o.clmm_pool_id][o.id]?r[o.clmm_pool_id][o.id]=r[o.clmm_pool_id][o.id].add(q):r[o.clmm_pool_id]&&!r[o.clmm_pool_id][o.id]?(r[o.clmm_pool_id][o.id]={},r[o.clmm_pool_id][o.id]=q):(r[o.clmm_pool_id]={},r[o.clmm_pool_id][o.id]={},r[o.clmm_pool_id][o.id]=q),console.log(this.farmsRewardObj,"##farmsRewardObj"),h=h.add(q),{...g,rewarderAmount:y.toString(),rewarderAmountUsd:q.toString(),rewarderType:X}}):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let C;if(o.id){const g=G.add(M);l[o.clmm_pool_id]||(l[o.clmm_pool_id]={}),l[o.clmm_pool_id][o.id]=g}console.log(this.farmsUserUsd,"##this.farmsUserUsd"),P.push({...o,minPrice:T,maxPrice:L,positionUSD:G.add(M).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:j,positionSource:o.creator?"clmm":"farming",farmsPoolId:m,coinA:u.coinA,coinB:u.coinB,positionShare:C,amountAUsd:G,amountBUsd:M,amountA:I,amountB:E,positionRewardAmount:h})}const w={};Object.keys(r).forEach(e=>{w[e]={},w[e].amountUsd=new a(0),typeof r[e]=="object"&&Object.keys(r[e]).forEach(o=>{console.log(o,r[e][o],"#######375"),w[e].amountUsd=w[e].amountUsd.add(r[e][o])})});const p={};Object.keys(l).forEach(e=>{p[e]={},p[e].amount=new a(0),p[e].positionNum=0,typeof l[e]=="object"&&Object.keys(l[e]).forEach(o=>{p[e].amount=p[e].amount.add(l[e][o]),p[e].positionNum+=1})}),console.log("farmsUserUsd:",l),console.log(w,"##farmsRewardObjResult"),this.farmsRewardObj={...this.farmsRewardObj,...w},this.farmsUserUsd={...this.farmsUserUsd,...p},this.farmsPositionObj[d]=P,this.farmsLoadingObj[d]=!1},async getPositionByAllPool(b){var w,p;this.farmsAllPositionLoading=!0;const d=H("Sui"),m=z("Sui"),t=await d.getOwnedFramsPositionNFTList(!0),O=await m.getPositionList(b,this.farmsPoolObj)||[];console.log(O,"###clmmPositionList");const U=t.concat(O);console.log(U,"##positionGroup");const f=[],n={},c={};for(let s=0;s<U.length;s++){const i=U[s],e=await m.getPool(i.clmm_pool_id||i.pool),o=m.getCoinAmountFromLiquidity({pool:e,position:i,roundUp:!1}),{RATES:u,tokensObj:S}=this.getPoolStore,_=this.farmsPoolObj[i.clmm_pool_id||i.pool],T=((w=u[_.coin_a.address])==null?void 0:w.price)||"",L=((p=u[_.coin_b.address])==null?void 0:p.price)||"",j=_.coin_a.decimals,N=_.coin_b.decimals,R=new a(o.coinaAmount).div(Math.pow(10,j)),k=new a(o.coinbAmount).div(Math.pow(10,N)),x=new a(o.coinaAmount).div(Math.pow(10,j)).mul(T),F=new a(o.coinbAmount).div(Math.pow(10,N)).mul(L);let B,v;i.tick_lower_index==m.TickUtil.getMinIndex(Number(_.tick_spacing))?B="0":B=m.TickMath.tickIndexToPrice(Number(i.tick_lower_index),j,N).toString(),i.tick_upper_index==m.TickUtil.getMaxIndex(Number(_.tick_spacing))?v="∞":v=m.TickMath.tickIndexToPrice(Number(i.tick_upper_index),j,N).toString();let I;const E=D.sqrtPriceX64ToPrice(e.current_sqrt_price,j,N).toString();Number(E)>=Number(B)&&(v==="∞"||Number(E)<=Number(v))?I="Active":(Number(E)>Number(v)||Number(E)<Number(B))&&(I="Inactive");let G;if(i.id){const h=x.add(F);c[i.clmm_pool_id]||(c[i.clmm_pool_id]={}),c[i.clmm_pool_id][i.id]=h}let M=new a(0);i.rewards&&i.rewards.length>0&&(i.rewards=i.rewards.map(h=>{var y;console.log(h,i,"#reward292");const C=h.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":h.rewarder_type,g=S[C];console.log(g,C,"tokenInfo##294");const X=((y=u[C])==null?void 0:y.price)||0,$=new a(h.rewarder_amount).div(new a(Math.pow(10,g==null?void 0:g.decimals))),A=$.mul(new a(X));return console.log(A,"##rewarderAmountUsd"),n[i.clmm_pool_id]&&n[i.clmm_pool_id][i.id]?n[i.clmm_pool_id][i.id]=n[i.clmm_pool_id][i.id].add(A):n[i.clmm_pool_id]&&!n[i.clmm_pool_id][i.id]?(n[i.clmm_pool_id][i.id]={},n[i.clmm_pool_id][i.id]=A):(n[i.clmm_pool_id]={},n[i.clmm_pool_id][i.id]={},n[i.clmm_pool_id][i.id]=A),M=M.add(A),{...h,rewarderAmount:$.toString(),rewarderAmountUsd:A.toString(),rewarderType:C}})),f.push({...i,minPrice:B,maxPrice:v,positionUSD:x.add(F).toNumber(),clmmPool:i.clmm_pool_id||i.pool,positionStatus:I,positionSource:i.creator?"clmm":"farming",farmsPoolId:i.pool_id,coinA:_.coinA,coinB:_.coinB,soucrce:i.id?"farming":"clmm",positionShare:G,amountAUsd:x.toString(),amountBUsd:F.toString(),amountA:R.toString(),amountB:k.toString(),positionRewardAmount:M})}this.farmsPositionList=f;const l={};f.forEach(s=>{l[s.clmm_pool_id||s.pool]||(l[s.clmm_pool_id||s.pool]=[]),l[s.clmm_pool_id||s.pool].push(s)}),this.farmsPositionObj=l,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),console.log(n,"##this.farmsRewardObj");const r={};Object.keys(n).forEach(s=>{console.log(n,s,"farmsRewardObj:"),r[s]={},r[s].amountUsd=new a(0),typeof n[s]=="object"&&Object.keys(n[s]).forEach(i=>{console.log(n[s][i].toString(),"#######375"),r[s].amountUsd=r[s].amountUsd.add(n[s][i]),console.log(r[s].amountUsd.toString(),"result[key].amountUsd.toString()")})});const P={};Object.keys(c).forEach(s=>{P[s]={},P[s].amount=new a(0),P[s].positionNum=0,typeof c[s]=="object"&&Object.keys(c[s]).forEach(i=>{P[s].amount=P[s].amount.add(c[s][i]),P[s].positionNum+=1})}),console.log("farmsUserUsd:",c),this.farmsRewardObj=r,this.farmsUserUsd=P,console.log(this.farmsRewardObj,"##this.farmsRewardObj"),this.getMyFarms()},getMyFarms(){const b=[];this.farmsPoolList.forEach(d=>{console.log(this.farmsPositionObj[d.clmm_pool_id],"this.this.farmsPositionObj[##");const m=this.farmsPositionObj[d.clmm_pool_id]&&this.farmsPositionObj[d.clmm_pool_id].filter(t=>t.positionSource=="farming");console.log(m,"getMyFarmsresult##"),m&&m.length>0&&b.push(d)}),this.myFarmsPoolList=b,console.log(b,"##myFarms")},logOut(){this.farmsPositionObj={},this.farmsUserUsd={},this.farmsRewardObj={},this.farmsPositionList=[],this.farmsAllPositionLoading=!1,this.myFarmsPoolList=[]}}});export{io as u};
