import{a7 as Q}from"./entry.e9996baa.js";import{u as V,T as G,e as z,m as H}from"./pool.59b1f7b9.js";import{D as l}from"./decimal.0bdeb344.js";import{c as W}from"./sha256.23fd7034.js";const io=Q("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return V()}},actions:{async getFarmsPoolList(h){h||(this.farmsPoolListLoading=!0);try{const{data:d}=await fetch(`${W.Sui.api}/v2/sui/swap/count`).then(t=>t.json()),_=d.pools.filter(t=>t.stable_farming);console.log(_,"#farmsPoolsfarmsPools");const u=_.map(t=>{var i,r,o;let S=0;console.log(t,"#farmsPool");const P=t.coin_a.decimals,a=t.coin_b.decimals,c=G.tickIndexToPrice(t.stable_farming.effective_tick_lower,P,a).toString(),m=G.tickIndexToPrice(t.stable_farming.effective_tick_upper,P,a).toString();let n=[];t.rewarder&&t.rewarder.rewarder_coin&&t.rewarder.rewarder_coin.length>0&&(n=(r=(i=t.rewarder)==null?void 0:i.rewarder_coin)==null?void 0:r.map((e,U)=>({...e,amountDay:new l(e.amount_second).mul(new l(60*60*24)).toNumber(),rewarder_display:t.rewarder[`rewarder_display${U+1}`],rewarderApr:e.apr.replace("%","")})));let p=!1;t.stable_farming&&t.stable_farming.stable_rewarder.map(e=>{e.amount_second>0&&(p=!0)});const b=t.stable_farming.stable_rewarder.map(e=>(S+=Number(e.amount_second),{emission_per_day:new l(e.amount_second).mul(60*60*24),reward_coin:e.coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":e.coin,symbol:e.symbol,allocate_point:Number(e.amount_second)>0?1:0})),f=t.apr_24h.replace("%",""),s=t.rewarder&&t.rewarder.apr.replace("%","")||0;return console.log(f,s,"rewardApr####"),console.log(S,t,"##totalAllocatePoint"),{...t,clmm_pool_id:t.swap_account,effective_tick_lower:t.stable_farming.effective_tick_lower,effective_tick_upper:t.stable_farming.effective_tick_upper,fee:t.fee*100+"%",id:t.stable_farming.stable_farming_pool,rewarders:b,status:S>0?"Live":"Ended",minPrice:c,maxPrice:m,coinA:t.coin_a,coinB:t.coin_b,stableFarmingApr:t.stable_farming&&t.stable_farming.apr*100,rewarder:{...t.rewarder,rewardList:n},isStableFarming:p,is_display_rewarder:(o=t==null?void 0:t.rewarder)==null?void 0:o.is_display_rewarder,aprTotal:Number(f)+Number(s),apr:t.apr_24h.replace("%",""),clmmApr:Number(f)+Number(s)}});this.farmsPoolList=u,this.farmsPoolObj=Object.fromEntries(u.map(t=>[t.clmm_pool_id,{...t,address:t.clmm_pool_id}])),this.farmsPoolListLoading=!1,console.log(_,u,"farmsPools####")}catch(d){console.log("getFarmsPoolList error:",d);const u=await z("Sui").getLpList(),t=Object.fromEntries(u.map((c,m)=>[c.address,c]));console.log(t,"cmmLpObj##");const P=await H("Sui").getFramsPoolList();console.log("getFarmsPoolList:",P);const a=P.map(c=>{const m=t[c.clmm_pool_id];let n=0;const{tokensObj:p}=this.getPoolStore,b=c.rewarders.map(o=>{const e=o.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":o.reward_coin,U=p[e].decimals,g=p[e].symbol;n=n+Number(o.allocate_point);const A=new l(o.allocate_point).div(new l(o.total_allocate_point));return{...o,reward_coin:e,emission_per_day:Number(o.allocate_point)>0?new l(o.emission_per_second).mul(A).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,U)).toString():"0",symbol:g}}),f=m.coinA.decimals,s=m.coinB.decimals,i=G.tickIndexToPrice(c.effective_tick_lower,f,s).toString(),r=G.tickIndexToPrice(c.effective_tick_upper,f,s).toString();return console.log(n,"allocatePoint##"),{...c,minPrice:i,maxPrice:r,fee:m.fee*100+"%",coinA:m.coinA,coinB:m.coinB,rewarders:b,status:n>0?"Live":"Ended",stable_farming:{apr:0,tvl:0},coin_a:m.coinA,coin_b:m.coinB}});console.log("getFarmsPoolList",a),this.farmsPoolList=a,this.farmsPoolObj=Object.fromEntries(a.map(c=>[c.clmm_pool_id,{...c,address:c.clmm_pool_id}])),this.cmmPoolInfoObj=t,this.farmsPoolListLoading=!1}},async getPositionByPool(h,d,_){var s,i;this.farmsLoadingObj[d]=!0;const u=z("Sui"),t=H("Sui");console.log(h,d,"#account, poolAddress");const P=(await t.getOwnedFramsPositionNFTList(!0)).filter(r=>r.clmm_pool_id==d),a=await u.getPositionList(h,{address:{address:d}})||[],c=P.concat(a);console.log(P,a,"###farmingPositionList"),console.log(c,"###positionGroup");const m={},n={},p=[];for(let r=0;r<c.length;r++){const o=c[r],e=this.farmsPoolObj[o.clmm_pool_id||o.pool];console.log(e,"##poolInfo");const U=e.coinA.decimals,g=e.coinB.decimals;let A,N;o.tick_lower_index==u.TickUtil.getMinIndex(Number(e.tick_spacing))?A="0":A=u.TickMath.tickIndexToPrice(Number(o.tick_lower_index),U,g).toString(),o.tick_upper_index==u.TickUtil.getMaxIndex(Number(e.tick_spacing))?N="∞":N=u.TickMath.tickIndexToPrice(Number(o.tick_upper_index),U,g).toString(),console.log(o,"#position.clmm_pool_id");let O;const x=await u.getPool(o.clmm_pool_id||o.pool),B=G.sqrtPriceX64ToPrice(x.current_sqrt_price,U,g).toString();Number(B)>=Number(A)&&(N==="∞"||Number(B)<=Number(N))?O="Active":(Number(B)>Number(N)||Number(B)<Number(A))&&(O="Inactive");const R=u.getCoinAmountFromLiquidity({pool:x,position:o,roundUp:!1}),{RATES:v,tokensObj:k}=this.getPoolStore;console.log(v,"##cmmPoolStore");const F=((s=v[e.coin_a.address])==null?void 0:s.price)||"",T=((i=v[e.coin_a.address])==null?void 0:i.price)||"",E=new l(R.coinaAmount).div(Math.pow(10,U)),y=new l(R.coinbAmount).div(Math.pow(10,g)),I=new l(R.coinaAmount).div(Math.pow(10,U)).mul(F),M=new l(R.coinbAmount).div(Math.pow(10,g)).mul(T);let j=new l(0);o.rewards&&o.rewards.length>0?o.rewards=o.rewards.map(w=>{var J;console.log(w,o,"reward##171");const X=w.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":w.rewarder_type,$=k[X];console.log(k,"##tokensObj");const L=((J=v[X])==null?void 0:J.price)||0,q=new l(w.rewarder_amount).div(new l(Math.pow(10,$.decimals)));console.log(q,L,"amount,rewardPrice");const D=q.mul(new l(L));return console.log(D.toString(),"rewarderAmountUsd"),n[o.clmm_pool_id]&&n[o.clmm_pool_id][o.id]?n[o.clmm_pool_id][o.id]=n[o.clmm_pool_id][o.id].add(D):n[o.clmm_pool_id]&&!n[o.clmm_pool_id][o.id]?(n[o.clmm_pool_id][o.id]={},n[o.clmm_pool_id][o.id]=D):(n[o.clmm_pool_id]={},n[o.clmm_pool_id][o.id]={},n[o.clmm_pool_id][o.id]=D),console.log(this.farmsRewardObj,"##farmsRewardObj"),j=j.add(D),{...w,rewarderAmount:q.toString(),rewarderAmountUsd:D.toString(),rewarderType:X}}):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let C;if(o.id){const w=I.add(M);m[o.clmm_pool_id]||(m[o.clmm_pool_id]={}),m[o.clmm_pool_id][o.id]=w}console.log(this.farmsUserUsd,"##this.farmsUserUsd"),p.push({...o,minPrice:A,maxPrice:N,positionUSD:I.add(M).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:O,positionSource:o.creator?"clmm":"farming",farmsPoolId:_,coinA:e.coinA,coinB:e.coinB,positionShare:C,amountAUsd:I,amountBUsd:M,amountA:E,amountB:y,positionRewardAmount:j})}const b={};Object.keys(n).forEach(r=>{b[r]={},b[r].amountUsd=new l(0),typeof n[r]=="object"&&Object.keys(n[r]).forEach(o=>{console.log(o,n[r][o],"#######375"),b[r].amountUsd=b[r].amountUsd.add(n[r][o])})});const f={};Object.keys(m).forEach(r=>{f[r]={},f[r].amount=new l(0),f[r].positionNum=0,typeof m[r]=="object"&&Object.keys(m[r]).forEach(o=>{f[r].amount=f[r].amount.add(m[r][o]),f[r].positionNum+=1})}),console.log("farmsUserUsd:",m),console.log(b,"##farmsRewardObjResult"),this.farmsRewardObj[d]={},this.farmsRewardObj={...this.farmsRewardObj,...b},this.farmsUserUsd[d]={},this.farmsUserUsd={...this.farmsUserUsd,...f},this.farmsPositionObj[d]=p,this.farmsLoadingObj[d]=!1,this.getMyFarms()},async getPositionByAllPool(h){var b,f;this.farmsAllPositionLoading=!0;const d=H("Sui"),_=z("Sui"),u=await d.getOwnedFramsPositionNFTList(!0),t=await _.getPositionList(h,this.farmsPoolObj)||[];console.log(t,"###clmmPositionList");const S=u.concat(t);console.log(S,"##positionGroup");const P=[],a={},c={};for(let s=0;s<S.length;s++){const i=S[s],r=await _.getPool(i.clmm_pool_id||i.pool),o=_.getCoinAmountFromLiquidity({pool:r,position:i,roundUp:!1}),{RATES:e,tokensObj:U}=this.getPoolStore,g=this.farmsPoolObj[i.clmm_pool_id||i.pool],A=((b=e[g.coin_a.address])==null?void 0:b.price)||"",N=((f=e[g.coin_b.address])==null?void 0:f.price)||"",O=g.coin_a.decimals,x=g.coin_b.decimals,B=new l(o.coinaAmount).div(Math.pow(10,O)),R=new l(o.coinbAmount).div(Math.pow(10,x)),v=new l(o.coinaAmount).div(Math.pow(10,O)).mul(A),k=new l(o.coinbAmount).div(Math.pow(10,x)).mul(N);let F,T;i.tick_lower_index==_.TickUtil.getMinIndex(Number(g.tick_spacing))?F="0":F=_.TickMath.tickIndexToPrice(Number(i.tick_lower_index),O,x).toString(),i.tick_upper_index==_.TickUtil.getMaxIndex(Number(g.tick_spacing))?T="∞":T=_.TickMath.tickIndexToPrice(Number(i.tick_upper_index),O,x).toString();let E;const y=G.sqrtPriceX64ToPrice(r.current_sqrt_price,O,x).toString();Number(y)>=Number(F)&&(T==="∞"||Number(y)<=Number(T))?E="Active":(Number(y)>Number(T)||Number(y)<Number(F))&&(E="Inactive");let I;if(i.id){const j=v.add(k);c[i.clmm_pool_id]||(c[i.clmm_pool_id]={}),c[i.clmm_pool_id][i.id]=j}let M=new l(0);i.rewards&&i.rewards.length>0&&(i.rewards=i.rewards.map(j=>{var q;console.log(j,i,"#reward292");const C=j.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":j.rewarder_type,w=U[C];console.log(w,C,"tokenInfo##294");const X=((q=e[C])==null?void 0:q.price)||0,$=new l(j.rewarder_amount).div(new l(Math.pow(10,w==null?void 0:w.decimals))),L=$.mul(new l(X));return console.log(L,"##rewarderAmountUsd"),a[i.clmm_pool_id]&&a[i.clmm_pool_id][i.id]?a[i.clmm_pool_id][i.id]=a[i.clmm_pool_id][i.id].add(L):a[i.clmm_pool_id]&&!a[i.clmm_pool_id][i.id]?(a[i.clmm_pool_id][i.id]={},a[i.clmm_pool_id][i.id]=L):(a[i.clmm_pool_id]={},a[i.clmm_pool_id][i.id]={},a[i.clmm_pool_id][i.id]=L),M=M.add(L),{...j,rewarderAmount:$.toString(),rewarderAmountUsd:L.toString(),rewarderType:C}})),P.push({...i,minPrice:F,maxPrice:T,positionUSD:v.add(k).toNumber(),clmmPool:i.clmm_pool_id||i.pool,positionStatus:E,positionSource:i.creator?"clmm":"farming",farmsPoolId:i.pool_id,coinA:g.coinA,coinB:g.coinB,soucrce:i.id?"farming":"clmm",positionShare:I,amountAUsd:v.toString(),amountBUsd:k.toString(),amountA:B.toString(),amountB:R.toString(),positionRewardAmount:M})}this.farmsPositionList=P;const m={};P.forEach(s=>{m[s.clmm_pool_id||s.pool]||(m[s.clmm_pool_id||s.pool]=[]),m[s.clmm_pool_id||s.pool].push(s)}),this.farmsPositionObj=m,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),console.log(a,"##this.farmsRewardObj");const n={};Object.keys(a).forEach(s=>{console.log(a,s,"farmsRewardObj:"),n[s]={},n[s].amountUsd=new l(0),typeof a[s]=="object"&&Object.keys(a[s]).forEach(i=>{console.log(a[s][i].toString(),"#######375"),n[s].amountUsd=n[s].amountUsd.add(a[s][i]),console.log(n[s].amountUsd.toString(),"result[key].amountUsd.toString()")})});const p={};Object.keys(c).forEach(s=>{p[s]={},p[s].amount=new l(0),p[s].positionNum=0,typeof c[s]=="object"&&Object.keys(c[s]).forEach(i=>{p[s].amount=p[s].amount.add(c[s][i]),p[s].positionNum+=1})}),console.log("farmsUserUsd:",c),this.farmsRewardObj=n,this.farmsUserUsd=p,console.log(this.farmsRewardObj,"##this.farmsRewardObj"),this.getMyFarms()},getMyFarms(){const h=[];this.farmsPoolList.forEach(d=>{console.log(this.farmsPositionObj[d.clmm_pool_id],"this.this.farmsPositionObj[##");const _=this.farmsPositionObj[d.clmm_pool_id]&&this.farmsPositionObj[d.clmm_pool_id].filter(u=>u.positionSource=="farming");console.log(_,"getMyFarmsresult##"),_&&_.length>0&&h.push(d)}),this.myFarmsPoolList=h,console.log(h,"##myFarms")},setFarmsLoadingObj(h){this.farmsLoadingObj[h]=!0},logOut(){this.farmsPositionObj={},this.farmsUserUsd={},this.farmsRewardObj={},this.farmsPositionList=[],this.farmsAllPositionLoading=!1,this.myFarmsPoolList=[]}}});export{io as u};
