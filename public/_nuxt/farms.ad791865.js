import{a7 as Y}from"./entry.bc47c957.js";import{u as Z,T as C,e as Q,m as V}from"./pool.29982694.js";import{D as l}from"./decimal.0bdeb344.js";import{c as K}from"./sha256.e607382f.js";const ro=Y("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return Z()}},actions:{async getFarmsPoolList(w){w||(this.farmsPoolListLoading=!0);try{const{data:d}=await fetch(`${K.Sui.api}/v2/sui/swap/count`).then(s=>s.json()),_=d.pools.filter(s=>s.stable_farming);console.log(_,"#farmsPoolsfarmsPools");const f=_.map(s=>{var i,r,o;let S=0;console.log(s,"#farmsPool");const h=s.coin_a.decimals,a=s.coin_b.decimals,c=C.tickIndexToPrice(s.stable_farming.effective_tick_lower,h,a).toString(),m=C.tickIndexToPrice(s.stable_farming.effective_tick_upper,h,a).toString();let n=[];s.rewarder&&s.rewarder.rewarder_coin&&s.rewarder.rewarder_coin.length>0&&(n=(r=(i=s.rewarder)==null?void 0:i.rewarder_coin)==null?void 0:r.map((e,j)=>({...e,amountDay:new l(e.amount_second).mul(new l(60*60*24)).toNumber(),rewarder_display:s.rewarder[`rewarder_display${j+1}`],rewarderApr:e.apr.replace("%","")})));let p=!1;s.stable_farming&&s.stable_farming.stable_rewarder.map(e=>{e.amount_second>0&&(p=!0)});const b=[];s.stable_farming.stable_rewarder.forEach(e=>{S+=Number(e.amount_second),e.amount_second>0&&b.push({emission_per_day:new l(e.amount_second).mul(60*60*24),reward_coin:e.coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":e.coin,symbol:e.symbol,allocate_point:Number(e.amount_second)>0?1:0})});const u=s.apr_24h.replace("%",""),t=s.rewarder&&s.rewarder.apr.replace("%","")||0;return console.log(u,t,"rewardApr####"),console.log(S,s,"##totalAllocatePoint"),{...s,clmm_pool_id:s.swap_account,effective_tick_lower:s.stable_farming.effective_tick_lower,effective_tick_upper:s.stable_farming.effective_tick_upper,fee:s.fee*100+"%",id:s.stable_farming.stable_farming_pool,rewarders:b,status:S>0?"Live":"Ended",minPrice:c,maxPrice:m,coinA:s.coin_a,coinB:s.coin_b,stableFarmingApr:s.stable_farming&&s.stable_farming.apr*100,rewarder:{...s.rewarder,rewardList:n},isStableFarming:p,is_display_rewarder:(o=s==null?void 0:s.rewarder)==null?void 0:o.is_display_rewarder,aprTotal:Number(u)+Number(t),apr:s.apr_24h.replace("%",""),clmmApr:Number(u)+Number(t)}});this.farmsPoolList=f,this.farmsPoolObj=Object.fromEntries(f.map(s=>[s.clmm_pool_id,{...s,address:s.clmm_pool_id}])),this.farmsPoolListLoading=!1,console.log(_,f,"farmsPools####")}catch(d){console.log("getFarmsPoolList error:",d);const f=await Q("Sui").getLpList(),s=Object.fromEntries(f.map((c,m)=>[c.address,c]));console.log(s,"cmmLpObj##");const h=await V("Sui").getFramsPoolList();console.log("getFarmsPoolList:",h);const a=h.map(c=>{const m=s[c.clmm_pool_id];let n=0;const{tokensObj:p}=this.getPoolStore,b=c.rewarders.map(o=>{const e=o.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":o.reward_coin,j=p[e].decimals,g=p[e].symbol;n=n+Number(o.allocate_point);const L=new l(o.allocate_point).div(new l(o.total_allocate_point));return{...o,reward_coin:e,emission_per_day:Number(o.allocate_point)>0?new l(o.emission_per_second).mul(L).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,j)).toString():"0",symbol:g}}),u=m.coinA.decimals,t=m.coinB.decimals,i=C.tickIndexToPrice(c.effective_tick_lower,u,t).toString(),r=C.tickIndexToPrice(c.effective_tick_upper,u,t).toString();return console.log(n,"allocatePoint##"),{...c,minPrice:i,maxPrice:r,fee:m.fee*100+"%",coinA:m.coinA,coinB:m.coinB,rewarders:b,status:n>0?"Live":"Ended",stable_farming:{apr:0,tvl:0},coin_a:m.coinA,coin_b:m.coinB}});console.log("getFarmsPoolList",a),this.farmsPoolList=a,this.farmsPoolObj=Object.fromEntries(a.map(c=>[c.clmm_pool_id,{...c,address:c.clmm_pool_id}])),this.cmmPoolInfoObj=s,this.farmsPoolListLoading=!1}},async getPositionByPool(w,d,_){var t,i;this.farmsLoadingObj[d]=!0;const f=Q("Sui"),s=V("Sui");console.log(w,d,"#account, poolAddress");const h=(await s.getOwnedFramsPositionNFTList(!0)).filter(r=>r.clmm_pool_id==d),a=await f.getPositionList(w,{address:{address:d}})||[],c=h.concat(a);console.log(h,a,"###farmingPositionList"),console.log(c,"###positionGroup");const m={},n={},p=[];for(let r=0;r<c.length;r++){const o=c[r],e=this.farmsPoolObj[o.clmm_pool_id||o.pool];console.log(e,"##poolInfo");const j=e.coinA.decimals,g=e.coinB.decimals;let L,A;o.tick_lower_index==f.TickUtil.getMinIndex(Number(e.tick_spacing))?L="0":L=f.TickMath.tickIndexToPrice(Number(o.tick_lower_index),j,g).toString(),o.tick_upper_index==f.TickUtil.getMaxIndex(Number(e.tick_spacing))?A="∞":A=f.TickMath.tickIndexToPrice(Number(o.tick_upper_index),j,g).toString(),console.log(o,"#position.clmm_pool_id");let U;const N=await f.getPool(o.clmm_pool_id||o.pool),M=C.sqrtPriceX64ToPrice(N.current_sqrt_price,j,g).toString();Number(M)>=Number(L)&&(A==="∞"||Number(M)<=Number(A))?U="Active":(Number(M)>Number(A)||Number(M)<Number(L))&&(U="Inactive");const B=f.getCoinAmountFromLiquidity({pool:N,position:o,roundUp:!1}),{RATES:x,tokensObj:I}=this.getPoolStore;console.log(x,"##cmmPoolStore");const R=((t=x[e.coin_a.address])==null?void 0:t.price)||"",v=((i=x[e.coin_a.address])==null?void 0:i.price)||"",k=new l(B.coinaAmount).div(Math.pow(10,j)),E=new l(B.coinbAmount).div(Math.pow(10,g)),q=new l(B.coinaAmount).div(Math.pow(10,j)).mul(R),T=new l(B.coinbAmount).div(Math.pow(10,g)).mul(v);let y=new l(0);const D=this.farmsPoolObj[o.clmm_pool_id];console.log("farmsPoolInfo:",D);const O=[];o.rewards&&o.rewards.length>0?(o.rewards.forEach((P,J)=>{var W;const G=P.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":P.rewarder_type,z=I[G],F=((W=x[G])==null?void 0:W.price)||0,X=new l(P.rewarder_amount).div(new l(Math.pow(10,z.decimals))),$=X.mul(new l(F));n[o.clmm_pool_id]&&n[o.clmm_pool_id][o.id]?n[o.clmm_pool_id][o.id]=n[o.clmm_pool_id][o.id].add($):n[o.clmm_pool_id]&&!n[o.clmm_pool_id][o.id]?(n[o.clmm_pool_id][o.id]={},n[o.clmm_pool_id][o.id]=$):(n[o.clmm_pool_id]={},n[o.clmm_pool_id][o.id]={},n[o.clmm_pool_id][o.id]=$),console.log(this.farmsRewardObj,"##farmsRewardObj"),y=y.add($),(D.rewarders[J].allocate_point>0||P.rewarder_amount>0)&&O.push({...P,rewarderAmount:X.toString(),rewarderAmountUsd:$.toString(),rewarderType:G})}),o.rewards=O):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let H;if(o.id){const P=q.add(T);m[o.clmm_pool_id]||(m[o.clmm_pool_id]={}),m[o.clmm_pool_id][o.id]=P}console.log(this.farmsUserUsd,"##this.farmsUserUsd"),p.push({...o,minPrice:L,maxPrice:A,positionUSD:q.add(T).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:U,positionSource:o.creator?"clmm":"farming",farmsPoolId:_,coinA:e.coinA,coinB:e.coinB,positionShare:H,amountAUsd:q,amountBUsd:T,amountA:k,amountB:E,positionRewardAmount:y})}const b={};Object.keys(n).forEach(r=>{b[r]={},b[r].amountUsd=new l(0),typeof n[r]=="object"&&Object.keys(n[r]).forEach(o=>{console.log(o,n[r][o],"#######375"),b[r].amountUsd=b[r].amountUsd.add(n[r][o])})});const u={};Object.keys(m).forEach(r=>{u[r]={},u[r].amount=new l(0),u[r].positionNum=0,typeof m[r]=="object"&&Object.keys(m[r]).forEach(o=>{u[r].amount=u[r].amount.add(m[r][o]),u[r].positionNum+=1})}),console.log("farmsUserUsd:",m),console.log(b,"##farmsRewardObjResult"),this.farmsRewardObj[d]={},this.farmsRewardObj={...this.farmsRewardObj,...b},this.farmsUserUsd[d]={},this.farmsUserUsd={...this.farmsUserUsd,...u},this.farmsPositionObj[d]=p,this.farmsLoadingObj[d]=!1,this.getMyFarms()},async getPositionByAllPool(w){var b,u;this.farmsAllPositionLoading=!0;const d=V("Sui"),_=Q("Sui"),f=await d.getOwnedFramsPositionNFTList(!0),s=await _.getPositionList(w,this.farmsPoolObj)||[];console.log(s,"###clmmPositionList");const S=f.concat(s);console.log(S,"##positionGroup");const h=[],a={},c={};for(let t=0;t<S.length;t++){const i=S[t],r=await _.getPool(i.clmm_pool_id||i.pool),o=_.getCoinAmountFromLiquidity({pool:r,position:i,roundUp:!1}),{RATES:e,tokensObj:j}=this.getPoolStore,g=this.farmsPoolObj[i.clmm_pool_id||i.pool],L=((b=e[g.coin_a.address])==null?void 0:b.price)||"",A=((u=e[g.coin_b.address])==null?void 0:u.price)||"",U=g.coin_a.decimals,N=g.coin_b.decimals,M=new l(o.coinaAmount).div(Math.pow(10,U)),B=new l(o.coinbAmount).div(Math.pow(10,N)),x=new l(o.coinaAmount).div(Math.pow(10,U)).mul(L),I=new l(o.coinbAmount).div(Math.pow(10,N)).mul(A);let R,v;i.tick_lower_index==_.TickUtil.getMinIndex(Number(g.tick_spacing))?R="0":R=_.TickMath.tickIndexToPrice(Number(i.tick_lower_index),U,N).toString(),i.tick_upper_index==_.TickUtil.getMaxIndex(Number(g.tick_spacing))?v="∞":v=_.TickMath.tickIndexToPrice(Number(i.tick_upper_index),U,N).toString();let k;const E=C.sqrtPriceX64ToPrice(r.current_sqrt_price,U,N).toString();Number(E)>=Number(R)&&(v==="∞"||Number(E)<=Number(v))?k="Active":(Number(E)>Number(v)||Number(E)<Number(R))&&(k="Inactive");let q;if(i.id){const O=x.add(I);c[i.clmm_pool_id]||(c[i.clmm_pool_id]={}),c[i.clmm_pool_id][i.id]=O}let T=new l(0);const y=this.farmsPoolObj[i.clmm_pool_id];console.log("farmsPoolInfo:",y);const D=[];i.rewards&&i.rewards.length>0?(i.rewards.forEach((O,H)=>{var X;const P=O.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":O.rewarder_type,J=j[P],G=((X=e[P])==null?void 0:X.price)||0,z=new l(O.rewarder_amount).div(new l(Math.pow(10,J.decimals))),F=z.mul(new l(G));a[i.clmm_pool_id]&&a[i.clmm_pool_id][i.id]?a[i.clmm_pool_id][i.id]=a[i.clmm_pool_id][i.id].add(F):a[i.clmm_pool_id]&&!a[i.clmm_pool_id][i.id]?(a[i.clmm_pool_id][i.id]={},a[i.clmm_pool_id][i.id]=F):(a[i.clmm_pool_id]={},a[i.clmm_pool_id][i.id]={},a[i.clmm_pool_id][i.id]=F),console.log(this.farmsRewardObj,"##farmsRewardObj"),T=T.add(F),(y.rewarders[H].allocate_point>0||O.rewarder_amount>0)&&D.push({...O,rewarderAmount:z.toString(),rewarderAmountUsd:F.toString(),rewarderType:P})}),i.rewards=D):(i.rewards=[],this.farmsRewardObj[i.clmm_pool_id]={}),h.push({...i,minPrice:R,maxPrice:v,positionUSD:x.add(I).toNumber(),clmmPool:i.clmm_pool_id||i.pool,positionStatus:k,positionSource:i.creator?"clmm":"farming",farmsPoolId:i.pool_id,coinA:g.coinA,coinB:g.coinB,soucrce:i.id?"farming":"clmm",positionShare:q,amountAUsd:x.toString(),amountBUsd:I.toString(),amountA:M.toString(),amountB:B.toString(),positionRewardAmount:T})}this.farmsPositionList=h;const m={};h.forEach(t=>{m[t.clmm_pool_id||t.pool]||(m[t.clmm_pool_id||t.pool]=[]),m[t.clmm_pool_id||t.pool].push(t)}),this.farmsPositionObj=m,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),console.log(a,"##this.farmsRewardObj");const n={};Object.keys(a).forEach(t=>{console.log(a,t,"farmsRewardObj:"),n[t]={},n[t].amountUsd=new l(0),typeof a[t]=="object"&&Object.keys(a[t]).forEach(i=>{console.log(a[t][i].toString(),"#######375"),n[t].amountUsd=n[t].amountUsd.add(a[t][i]),console.log(n[t].amountUsd.toString(),"result[key].amountUsd.toString()")})});const p={};Object.keys(c).forEach(t=>{p[t]={},p[t].amount=new l(0),p[t].positionNum=0,typeof c[t]=="object"&&Object.keys(c[t]).forEach(i=>{p[t].amount=p[t].amount.add(c[t][i]),p[t].positionNum+=1})}),console.log("farmsUserUsd:",c),this.farmsRewardObj=n,this.farmsUserUsd=p,console.log(this.farmsRewardObj,"##this.farmsRewardObj"),this.getMyFarms()},getMyFarms(){const w=[];this.farmsPoolList.forEach(d=>{console.log(this.farmsPositionObj[d.clmm_pool_id],"this.this.farmsPositionObj[##");const _=this.farmsPositionObj[d.clmm_pool_id]&&this.farmsPositionObj[d.clmm_pool_id].filter(f=>f.positionSource=="farming");console.log(_,"getMyFarmsresult##"),_&&_.length>0&&w.push(d)}),this.myFarmsPoolList=w,console.log(w,"##myFarms")},setFarmsLoadingObj(w){this.farmsLoadingObj[w]=!0},logOut(){this.farmsPositionObj={},this.farmsUserUsd={},this.farmsRewardObj={},this.farmsPositionList=[],this.farmsAllPositionLoading=!1,this.myFarmsPoolList=[]}}});export{ro as u};
