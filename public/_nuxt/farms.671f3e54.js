import{a7 as Q}from"./entry.67ef8ab7.js";import{u as V,T as G,e as z,m as H}from"./pool.a8efa1b0.js";import{D as a}from"./decimal.0bdeb344.js";import{c as W}from"./sha256.3d727558.js";const io=Q("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return V()}},actions:{async getFarmsPoolList(){this.farmsPoolListLoading=!0;try{const{data:h}=await fetch(`${W.Sui.api}/v2/sui/swap/count`).then(t=>t.json()),m=h.pools.filter(t=>t.stable_farming);console.log(m,"#farmsPoolsfarmsPools");const d=m.map(t=>{var s,i,r;let O=0;console.log(t,"#farmsPool");const U=t.coin_a.decimals,b=t.coin_b.decimals,n=G.tickIndexToPrice(t.stable_farming.effective_tick_lower,U,b).toString(),c=G.tickIndexToPrice(t.stable_farming.effective_tick_upper,U,b).toString();let l=[];t.rewarder&&t.rewarder.rewarder_coin&&t.rewarder.rewarder_coin.length>0&&(l=(i=(s=t.rewarder)==null?void 0:s.rewarder_coin)==null?void 0:i.map((o,u)=>({...o,amountDay:new a(o.amount_second).mul(new a(60*60*24)).toNumber(),rewarder_display:t.rewarder[`rewarder_display${u+1}`],rewarderApr:o.apr.replace("%","")})));let e=!1;t.stable_farming&&t.stable_farming.stable_rewarder.map(o=>{o.amount_second>0&&(e=!0)});const g=t.stable_farming.stable_rewarder.map(o=>(O+=Number(o.amount_second),{emission_per_day:new a(o.amount_second).mul(60*60*24),reward_coin:o.coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":o.coin,symbol:o.symbol,allocate_point:Number(o.amount_second)>0?1:0})),f=t.apr_24h.replace("%",""),_=t.rewarder&&t.rewarder.apr.replace("%","")||0;return console.log(f,_,"rewardApr####"),console.log(O,t,"##totalAllocatePoint"),{...t,clmm_pool_id:t.swap_account,effective_tick_lower:t.stable_farming.effective_tick_lower,effective_tick_upper:t.stable_farming.effective_tick_upper,fee:t.fee*100+"%",id:t.stable_farming.stable_farming_pool,rewarders:g,status:O>0?"Live":"Ended",minPrice:n,maxPrice:c,coinA:t.coin_a,coinB:t.coin_b,stableFarmingApr:t.stable_farming&&t.stable_farming.apr*100,rewarder:{...t.rewarder,rewardList:l},isStableFarming:e,is_display_rewarder:(r=t==null?void 0:t.rewarder)==null?void 0:r.is_display_rewarder,aprTotal:Number(f)+Number(_),apr:t.apr_24h.replace("%",""),clmmApr:Number(f)+Number(_)}});this.farmsPoolList=d,this.farmsPoolObj=Object.fromEntries(d.map(t=>[t.clmm_pool_id,{...t,address:t.clmm_pool_id}])),this.farmsPoolListLoading=!1,console.log(m,d,"farmsPools####")}catch(h){console.log("getFarmsPoolList error:",h);const d=await z("Sui").getLpList(),t=Object.fromEntries(d.map((n,c)=>[n.address,n]));console.log(t,"cmmLpObj##");const U=await H("Sui").getFramsPoolList();console.log("getFarmsPoolList:",U);const b=U.map(n=>{const c=t[n.clmm_pool_id];let l=0;const{tokensObj:e}=this.getPoolStore,g=n.rewarders.map(r=>{const o=r.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":r.reward_coin,u=e[o].decimals,S=e[o].symbol;l=l+Number(r.allocate_point);const p=new a(r.allocate_point).div(new a(r.total_allocate_point));return{...r,reward_coin:o,emission_per_day:Number(r.allocate_point)>0?new a(r.emission_per_second).mul(p).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,u)).toString():"0",symbol:S}}),f=c.coinA.decimals,_=c.coinB.decimals,s=G.tickIndexToPrice(n.effective_tick_lower,f,_).toString(),i=G.tickIndexToPrice(n.effective_tick_upper,f,_).toString();return console.log(l,"allocatePoint##"),{...n,minPrice:s,maxPrice:i,fee:c.fee*100+"%",coinA:c.coinA,coinB:c.coinB,rewarders:g,status:l>0?"Live":"Ended",stable_farming:{apr:0,tvl:0},coin_a:c.coinA,coin_b:c.coinB}});console.log("getFarmsPoolList",b),this.farmsPoolList=b,this.farmsPoolObj=Object.fromEntries(b.map(n=>[n.clmm_pool_id,{...n,address:n.clmm_pool_id}])),this.cmmPoolInfoObj=t,this.farmsPoolListLoading=!1}},async getPositionByPool(h,m,d){var s,i;this.farmsLoadingObj[m]=!0;const t=z("Sui"),O=H("Sui");console.log(h,m,"#account, poolAddress");const b=(await O.getOwnedFramsPositionNFTList(!0)).filter(r=>r.clmm_pool_id==m),n=await t.getPositionList(h,{address:{address:m}})||[],c=b.concat(n);console.log(b,n,"###farmingPositionList"),console.log(c,"###positionGroup");const l={},e={},g=[];for(let r=0;r<c.length;r++){const o=c[r],u=this.farmsPoolObj[o.clmm_pool_id||o.pool];console.log(u,"##poolInfo");const S=u.coinA.decimals,p=u.coinB.decimals;let T,L;o.tick_lower_index==t.TickUtil.getMinIndex(Number(u.tick_spacing))?T="0":T=t.TickMath.tickIndexToPrice(Number(o.tick_lower_index),S,p).toString(),o.tick_upper_index==t.TickUtil.getMaxIndex(Number(u.tick_spacing))?L="∞":L=t.TickMath.tickIndexToPrice(Number(o.tick_upper_index),S,p).toString(),console.log(o,"#position.clmm_pool_id");let j;const N=await t.getPool(o.clmm_pool_id||o.pool),F=G.sqrtPriceX64ToPrice(N.current_sqrt_price,S,p).toString();Number(F)>=Number(T)&&(L==="∞"||Number(F)<=Number(L))?j="Active":(Number(F)>Number(L)||Number(F)<Number(T))&&(j="Inactive");const R=t.getCoinAmountFromLiquidity({pool:N,position:o,roundUp:!1}),{RATES:x,tokensObj:k}=this.getPoolStore;console.log(x,"##cmmPoolStore");const M=((s=x[u.coin_a.address])==null?void 0:s.price)||"",v=((i=x[u.coin_a.address])==null?void 0:i.price)||"",E=new a(R.coinaAmount).div(Math.pow(10,S)),y=new a(R.coinbAmount).div(Math.pow(10,p)),I=new a(R.coinaAmount).div(Math.pow(10,S)).mul(M),B=new a(R.coinbAmount).div(Math.pow(10,p)).mul(v);let P=new a(0);o.rewards&&o.rewards.length>0?o.rewards=o.rewards.map(w=>{var J;console.log(w,o,"reward##171");const X=w.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":w.rewarder_type,$=k[X];console.log(k,"##tokensObj");const A=((J=x[X])==null?void 0:J.price)||0,q=new a(w.rewarder_amount).div(new a(Math.pow(10,$.decimals)));console.log(q,A,"amount,rewardPrice");const D=q.mul(new a(A));return console.log(D.toString(),"rewarderAmountUsd"),e[o.clmm_pool_id]&&e[o.clmm_pool_id][o.id]?e[o.clmm_pool_id][o.id]=e[o.clmm_pool_id][o.id].add(D):e[o.clmm_pool_id]&&!e[o.clmm_pool_id][o.id]?(e[o.clmm_pool_id][o.id]={},e[o.clmm_pool_id][o.id]=D):(e[o.clmm_pool_id]={},e[o.clmm_pool_id][o.id]={},e[o.clmm_pool_id][o.id]=D),console.log(this.farmsRewardObj,"##farmsRewardObj"),P=P.add(D),{...w,rewarderAmount:q.toString(),rewarderAmountUsd:D.toString(),rewarderType:X}}):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let C;if(o.id){const w=I.add(B);l[o.clmm_pool_id]||(l[o.clmm_pool_id]={}),l[o.clmm_pool_id][o.id]=w}console.log(this.farmsUserUsd,"##this.farmsUserUsd"),g.push({...o,minPrice:T,maxPrice:L,positionUSD:I.add(B).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:j,positionSource:o.creator?"clmm":"farming",farmsPoolId:d,coinA:u.coinA,coinB:u.coinB,positionShare:C,amountAUsd:I,amountBUsd:B,amountA:E,amountB:y,positionRewardAmount:P})}const f={};Object.keys(e).forEach(r=>{f[r]={},f[r].amountUsd=new a(0),typeof e[r]=="object"&&Object.keys(e[r]).forEach(o=>{console.log(o,e[r][o],"#######375"),f[r].amountUsd=f[r].amountUsd.add(e[r][o])})});const _={};Object.keys(l).forEach(r=>{_[r]={},_[r].amount=new a(0),_[r].positionNum=0,typeof l[r]=="object"&&Object.keys(l[r]).forEach(o=>{_[r].amount=_[r].amount.add(l[r][o]),_[r].positionNum+=1})}),console.log("farmsUserUsd:",l),console.log(f,"##farmsRewardObjResult"),this.farmsRewardObj[m]={},this.farmsRewardObj={...this.farmsRewardObj,...f},this.farmsUserUsd[m]={},this.farmsUserUsd={...this.farmsUserUsd,..._},this.farmsPositionObj[m]=g,this.farmsLoadingObj[m]=!1,this.getMyFarms()},async getPositionByAllPool(h){var f,_;this.farmsAllPositionLoading=!0;const m=H("Sui"),d=z("Sui"),t=await m.getOwnedFramsPositionNFTList(!0),O=await d.getPositionList(h,this.farmsPoolObj)||[];console.log(O,"###clmmPositionList");const U=t.concat(O);console.log(U,"##positionGroup");const b=[],n={},c={};for(let s=0;s<U.length;s++){const i=U[s],r=await d.getPool(i.clmm_pool_id||i.pool),o=d.getCoinAmountFromLiquidity({pool:r,position:i,roundUp:!1}),{RATES:u,tokensObj:S}=this.getPoolStore,p=this.farmsPoolObj[i.clmm_pool_id||i.pool],T=((f=u[p.coin_a.address])==null?void 0:f.price)||"",L=((_=u[p.coin_b.address])==null?void 0:_.price)||"",j=p.coin_a.decimals,N=p.coin_b.decimals,F=new a(o.coinaAmount).div(Math.pow(10,j)),R=new a(o.coinbAmount).div(Math.pow(10,N)),x=new a(o.coinaAmount).div(Math.pow(10,j)).mul(T),k=new a(o.coinbAmount).div(Math.pow(10,N)).mul(L);let M,v;i.tick_lower_index==d.TickUtil.getMinIndex(Number(p.tick_spacing))?M="0":M=d.TickMath.tickIndexToPrice(Number(i.tick_lower_index),j,N).toString(),i.tick_upper_index==d.TickUtil.getMaxIndex(Number(p.tick_spacing))?v="∞":v=d.TickMath.tickIndexToPrice(Number(i.tick_upper_index),j,N).toString();let E;const y=G.sqrtPriceX64ToPrice(r.current_sqrt_price,j,N).toString();Number(y)>=Number(M)&&(v==="∞"||Number(y)<=Number(v))?E="Active":(Number(y)>Number(v)||Number(y)<Number(M))&&(E="Inactive");let I;if(i.id){const P=x.add(k);c[i.clmm_pool_id]||(c[i.clmm_pool_id]={}),c[i.clmm_pool_id][i.id]=P}let B=new a(0);i.rewards&&i.rewards.length>0&&(i.rewards=i.rewards.map(P=>{var q;console.log(P,i,"#reward292");const C=P.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":P.rewarder_type,w=S[C];console.log(w,C,"tokenInfo##294");const X=((q=u[C])==null?void 0:q.price)||0,$=new a(P.rewarder_amount).div(new a(Math.pow(10,w==null?void 0:w.decimals))),A=$.mul(new a(X));return console.log(A,"##rewarderAmountUsd"),n[i.clmm_pool_id]&&n[i.clmm_pool_id][i.id]?n[i.clmm_pool_id][i.id]=n[i.clmm_pool_id][i.id].add(A):n[i.clmm_pool_id]&&!n[i.clmm_pool_id][i.id]?(n[i.clmm_pool_id][i.id]={},n[i.clmm_pool_id][i.id]=A):(n[i.clmm_pool_id]={},n[i.clmm_pool_id][i.id]={},n[i.clmm_pool_id][i.id]=A),B=B.add(A),{...P,rewarderAmount:$.toString(),rewarderAmountUsd:A.toString(),rewarderType:C}})),b.push({...i,minPrice:M,maxPrice:v,positionUSD:x.add(k).toNumber(),clmmPool:i.clmm_pool_id||i.pool,positionStatus:E,positionSource:i.creator?"clmm":"farming",farmsPoolId:i.pool_id,coinA:p.coinA,coinB:p.coinB,soucrce:i.id?"farming":"clmm",positionShare:I,amountAUsd:x.toString(),amountBUsd:k.toString(),amountA:F.toString(),amountB:R.toString(),positionRewardAmount:B})}this.farmsPositionList=b;const l={};b.forEach(s=>{l[s.clmm_pool_id||s.pool]||(l[s.clmm_pool_id||s.pool]=[]),l[s.clmm_pool_id||s.pool].push(s)}),this.farmsPositionObj=l,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),console.log(n,"##this.farmsRewardObj");const e={};Object.keys(n).forEach(s=>{console.log(n,s,"farmsRewardObj:"),e[s]={},e[s].amountUsd=new a(0),typeof n[s]=="object"&&Object.keys(n[s]).forEach(i=>{console.log(n[s][i].toString(),"#######375"),e[s].amountUsd=e[s].amountUsd.add(n[s][i]),console.log(e[s].amountUsd.toString(),"result[key].amountUsd.toString()")})});const g={};Object.keys(c).forEach(s=>{g[s]={},g[s].amount=new a(0),g[s].positionNum=0,typeof c[s]=="object"&&Object.keys(c[s]).forEach(i=>{g[s].amount=g[s].amount.add(c[s][i]),g[s].positionNum+=1})}),console.log("farmsUserUsd:",c),this.farmsRewardObj=e,this.farmsUserUsd=g,console.log(this.farmsRewardObj,"##this.farmsRewardObj"),this.getMyFarms()},getMyFarms(){const h=[];this.farmsPoolList.forEach(m=>{console.log(this.farmsPositionObj[m.clmm_pool_id],"this.this.farmsPositionObj[##");const d=this.farmsPositionObj[m.clmm_pool_id]&&this.farmsPositionObj[m.clmm_pool_id].filter(t=>t.positionSource=="farming");console.log(d,"getMyFarmsresult##"),d&&d.length>0&&h.push(m)}),this.myFarmsPoolList=h,console.log(h,"##myFarms")},logOut(){this.farmsPositionObj={},this.farmsUserUsd={},this.farmsRewardObj={},this.farmsPositionList=[],this.farmsAllPositionLoading=!1,this.myFarmsPoolList=[]}}});export{io as u};
