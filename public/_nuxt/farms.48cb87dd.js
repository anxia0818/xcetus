import{a7 as Q}from"./entry.2f05772d.js";import{u as V,T as D,e as z,m as H}from"./pool.f843b109.js";import{D as a}from"./decimal.0bdeb344.js";import{c as W}from"./sha256.07ddf552.js";const to=Q("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return V()}},actions:{async getFarmsPoolList(){this.farmsPoolListLoading=!0;try{const{data:b}=await fetch(`${W.Sui.api}/v2/sui/swap/count`).then(i=>i.json()),l=b.pools.filter(i=>i.stable_farming);console.log(l,"#farmsPoolsfarmsPools");const d=l.map(i=>{let O=0;console.log(i,"#farmsPool");const U=i.coin_a.decimals,f=i.coin_b.decimals,n=D.tickIndexToPrice(i.stable_farming.effective_tick_lower,U,f).toString(),c=D.tickIndexToPrice(i.stable_farming.effective_tick_upper,U,f).toString(),m=i.stable_farming.stable_rewarder.map(r=>(O+=Number(r.amount_second),{emission_per_day:new a(r.amount_second).mul(60*60*24),reward_coin:r.coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":r.coin,symbol:r.symbol,allocate_point:Number(r.amount_second)>0?1:0}));return console.log(O,i,"##totalAllocatePoint"),{...i,clmm_pool_id:i.swap_account,effective_tick_lower:i.stable_farming.effective_tick_lower,effective_tick_upper:i.stable_farming.effective_tick_upper,fee:i.fee*100+"%",id:i.stable_farming.stable_farming_pool,rewarders:m,status:O>0?"Live":"Ended",minPrice:n,maxPrice:c,coinA:i.coin_a,coinB:i.coin_b,stableFarmingApr:i.stable_farming&&i.stable_farming.apr*100}});this.farmsPoolList=d,this.farmsPoolObj=Object.fromEntries(d.map(i=>[i.clmm_pool_id,{...i,address:i.clmm_pool_id}])),this.farmsPoolListLoading=!1,console.log(l,d,"farmsPools####")}catch(b){console.log("getFarmsPoolList error:",b);const d=await z("Sui").getLpList(),i=Object.fromEntries(d.map((n,c)=>[n.address,n]));console.log(i,"cmmLpObj##");const U=await H("Sui").getFramsPoolList();console.log("getFarmsPoolList:",U);const f=U.map(n=>{const c=i[n.clmm_pool_id];let m=0;const{tokensObj:r}=this.getPoolStore,P=n.rewarders.map(e=>{const o=e.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":e.reward_coin,u=r[o].decimals,S=r[o].symbol;m=m+Number(e.allocate_point);const _=new a(e.allocate_point).div(new a(e.total_allocate_point));return{...e,reward_coin:o,emission_per_day:Number(e.allocate_point)>0?new a(e.emission_per_second).mul(_).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,u)).toString():"0",symbol:S}}),w=c.coinA.decimals,p=c.coinB.decimals,s=D.tickIndexToPrice(n.effective_tick_lower,w,p).toString(),t=D.tickIndexToPrice(n.effective_tick_upper,w,p).toString();return console.log(m,"allocatePoint##"),{...n,minPrice:s,maxPrice:t,fee:c.fee*100+"%",coinA:c.coinA,coinB:c.coinB,rewarders:P,status:m>0?"Live":"Ended",stable_farming:{apr:0,tvl:0},coin_a:c.coinA,coin_b:c.coinB}});console.log("getFarmsPoolList",f),this.farmsPoolList=f,this.farmsPoolObj=Object.fromEntries(f.map(n=>[n.clmm_pool_id,{...n,address:n.clmm_pool_id}])),this.cmmPoolInfoObj=i,this.farmsPoolListLoading=!1}},async getPositionByPool(b,l,d){var s,t;this.farmsLoadingObj[l]=!0;const i=z("Sui"),O=H("Sui");console.log(b,l,"#account, poolAddress");const f=(await O.getOwnedFramsPositionNFTList(!0)).filter(e=>e.clmm_pool_id==l),n=await i.getPositionList(b,{address:{address:l}})||[],c=f.concat(n);console.log(f,n,"###farmingPositionList"),console.log(c,"###positionGroup");const m={},r={},P=[];for(let e=0;e<c.length;e++){const o=c[e],u=this.farmsPoolObj[o.clmm_pool_id||o.pool];console.log(u,"##poolInfo");const S=u.coinA.decimals,_=u.coinB.decimals;let T,A;o.tick_lower_index==i.TickUtil.getMinIndex(Number(u.tick_spacing))?T="0":T=i.TickMath.tickIndexToPrice(Number(o.tick_lower_index),S,_).toString(),o.tick_upper_index==i.TickUtil.getMaxIndex(Number(u.tick_spacing))?A="∞":A=i.TickMath.tickIndexToPrice(Number(o.tick_upper_index),S,_).toString(),console.log(o,"#position.clmm_pool_id");let j;const N=await i.getPool(o.clmm_pool_id||o.pool),R=D.sqrtPriceX64ToPrice(N.current_sqrt_price,S,_).toString();Number(R)>=Number(T)&&(A==="∞"||Number(R)<=Number(A))?j="Active":(Number(R)>Number(A)||Number(R)<Number(T))&&(j="Inactive");const F=i.getCoinAmountFromLiquidity({pool:N,position:o,roundUp:!1}),{RATES:x,tokensObj:k}=this.getPoolStore;console.log(x,"##cmmPoolStore");const M=((s=x[u.coin_a.address])==null?void 0:s.price)||"",v=((t=x[u.coin_a.address])==null?void 0:t.price)||"",I=new a(F.coinaAmount).div(Math.pow(10,S)),E=new a(F.coinbAmount).div(Math.pow(10,_)),G=new a(F.coinaAmount).div(Math.pow(10,S)).mul(M),B=new a(F.coinbAmount).div(Math.pow(10,_)).mul(v);let h=new a(0);o.rewards&&o.rewards.length>0?o.rewards=o.rewards.map(g=>{var J;console.log(g,o,"reward##171");const X=g.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":g.rewarder_type,$=k[X];console.log(k,"##tokensObj");const L=((J=x[X])==null?void 0:J.price)||0,C=new a(g.rewarder_amount).div(new a(Math.pow(10,$.decimals)));console.log(C,L,"amount,rewardPrice");const q=C.mul(new a(L));return console.log(q.toString(),"rewarderAmountUsd"),r[o.clmm_pool_id]&&r[o.clmm_pool_id][o.id]?r[o.clmm_pool_id][o.id]=r[o.clmm_pool_id][o.id].add(q):r[o.clmm_pool_id]&&!r[o.clmm_pool_id][o.id]?(r[o.clmm_pool_id][o.id]={},r[o.clmm_pool_id][o.id]=q):(r[o.clmm_pool_id]={},r[o.clmm_pool_id][o.id]={},r[o.clmm_pool_id][o.id]=q),console.log(this.farmsRewardObj,"##farmsRewardObj"),h=h.add(q),{...g,rewarderAmount:C.toString(),rewarderAmountUsd:q.toString(),rewarderType:X}}):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let y;if(o.id){const g=G.add(B);m[o.clmm_pool_id]||(m[o.clmm_pool_id]={}),m[o.clmm_pool_id][o.id]=g}console.log(this.farmsUserUsd,"##this.farmsUserUsd"),P.push({...o,minPrice:T,maxPrice:A,positionUSD:G.add(B).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:j,positionSource:o.creator?"clmm":"farming",farmsPoolId:d,coinA:u.coinA,coinB:u.coinB,positionShare:y,amountAUsd:G,amountBUsd:B,amountA:I,amountB:E,positionRewardAmount:h})}const w={};Object.keys(r).forEach(e=>{w[e]={},w[e].amountUsd=new a(0),typeof r[e]=="object"&&Object.keys(r[e]).forEach(o=>{console.log(o,r[e][o],"#######375"),w[e].amountUsd=w[e].amountUsd.add(r[e][o])})});const p={};Object.keys(m).forEach(e=>{p[e]={},p[e].amount=new a(0),p[e].positionNum=0,typeof m[e]=="object"&&Object.keys(m[e]).forEach(o=>{p[e].amount=p[e].amount.add(m[e][o]),p[e].positionNum+=1})}),console.log("farmsUserUsd:",m),console.log(w,"##farmsRewardObjResult"),this.farmsRewardObj[l]={},this.farmsRewardObj={...this.farmsRewardObj,...w},this.farmsUserUsd[l]={},this.farmsUserUsd={...this.farmsUserUsd,...p},this.farmsPositionObj[l]=P,this.farmsLoadingObj[l]=!1,this.getMyFarms()},async getPositionByAllPool(b){var w,p;this.farmsAllPositionLoading=!0;const l=H("Sui"),d=z("Sui"),i=await l.getOwnedFramsPositionNFTList(!0),O=await d.getPositionList(b,this.farmsPoolObj)||[];console.log(O,"###clmmPositionList");const U=i.concat(O);console.log(U,"##positionGroup");const f=[],n={},c={};for(let s=0;s<U.length;s++){const t=U[s],e=await d.getPool(t.clmm_pool_id||t.pool),o=d.getCoinAmountFromLiquidity({pool:e,position:t,roundUp:!1}),{RATES:u,tokensObj:S}=this.getPoolStore,_=this.farmsPoolObj[t.clmm_pool_id||t.pool],T=((w=u[_.coin_a.address])==null?void 0:w.price)||"",A=((p=u[_.coin_b.address])==null?void 0:p.price)||"",j=_.coin_a.decimals,N=_.coin_b.decimals,R=new a(o.coinaAmount).div(Math.pow(10,j)),F=new a(o.coinbAmount).div(Math.pow(10,N)),x=new a(o.coinaAmount).div(Math.pow(10,j)).mul(T),k=new a(o.coinbAmount).div(Math.pow(10,N)).mul(A);let M,v;t.tick_lower_index==d.TickUtil.getMinIndex(Number(_.tick_spacing))?M="0":M=d.TickMath.tickIndexToPrice(Number(t.tick_lower_index),j,N).toString(),t.tick_upper_index==d.TickUtil.getMaxIndex(Number(_.tick_spacing))?v="∞":v=d.TickMath.tickIndexToPrice(Number(t.tick_upper_index),j,N).toString();let I;const E=D.sqrtPriceX64ToPrice(e.current_sqrt_price,j,N).toString();Number(E)>=Number(M)&&(v==="∞"||Number(E)<=Number(v))?I="Active":(Number(E)>Number(v)||Number(E)<Number(M))&&(I="Inactive");let G;if(t.id){const h=x.add(k);c[t.clmm_pool_id]||(c[t.clmm_pool_id]={}),c[t.clmm_pool_id][t.id]=h}let B=new a(0);t.rewards&&t.rewards.length>0&&(t.rewards=t.rewards.map(h=>{var C;console.log(h,t,"#reward292");const y=h.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":h.rewarder_type,g=S[y];console.log(g,y,"tokenInfo##294");const X=((C=u[y])==null?void 0:C.price)||0,$=new a(h.rewarder_amount).div(new a(Math.pow(10,g==null?void 0:g.decimals))),L=$.mul(new a(X));return console.log(L,"##rewarderAmountUsd"),n[t.clmm_pool_id]&&n[t.clmm_pool_id][t.id]?n[t.clmm_pool_id][t.id]=n[t.clmm_pool_id][t.id].add(L):n[t.clmm_pool_id]&&!n[t.clmm_pool_id][t.id]?(n[t.clmm_pool_id][t.id]={},n[t.clmm_pool_id][t.id]=L):(n[t.clmm_pool_id]={},n[t.clmm_pool_id][t.id]={},n[t.clmm_pool_id][t.id]=L),B=B.add(L),{...h,rewarderAmount:$.toString(),rewarderAmountUsd:L.toString(),rewarderType:y}})),f.push({...t,minPrice:M,maxPrice:v,positionUSD:x.add(k).toNumber(),clmmPool:t.clmm_pool_id||t.pool,positionStatus:I,positionSource:t.creator?"clmm":"farming",farmsPoolId:t.pool_id,coinA:_.coinA,coinB:_.coinB,soucrce:t.id?"farming":"clmm",positionShare:G,amountAUsd:x.toString(),amountBUsd:k.toString(),amountA:R.toString(),amountB:F.toString(),positionRewardAmount:B})}this.farmsPositionList=f;const m={};f.forEach(s=>{m[s.clmm_pool_id||s.pool]||(m[s.clmm_pool_id||s.pool]=[]),m[s.clmm_pool_id||s.pool].push(s)}),this.farmsPositionObj=m,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),console.log(n,"##this.farmsRewardObj");const r={};Object.keys(n).forEach(s=>{console.log(n,s,"farmsRewardObj:"),r[s]={},r[s].amountUsd=new a(0),typeof n[s]=="object"&&Object.keys(n[s]).forEach(t=>{console.log(n[s][t].toString(),"#######375"),r[s].amountUsd=r[s].amountUsd.add(n[s][t]),console.log(r[s].amountUsd.toString(),"result[key].amountUsd.toString()")})});const P={};Object.keys(c).forEach(s=>{P[s]={},P[s].amount=new a(0),P[s].positionNum=0,typeof c[s]=="object"&&Object.keys(c[s]).forEach(t=>{P[s].amount=P[s].amount.add(c[s][t]),P[s].positionNum+=1})}),console.log("farmsUserUsd:",c),this.farmsRewardObj=r,this.farmsUserUsd=P,console.log(this.farmsRewardObj,"##this.farmsRewardObj"),this.getMyFarms()},getMyFarms(){const b=[];this.farmsPoolList.forEach(l=>{console.log(this.farmsPositionObj[l.clmm_pool_id],"this.this.farmsPositionObj[##");const d=this.farmsPositionObj[l.clmm_pool_id]&&this.farmsPositionObj[l.clmm_pool_id].filter(i=>i.positionSource=="farming");console.log(d,"getMyFarmsresult##"),d&&d.length>0&&b.push(l)}),this.myFarmsPoolList=b,console.log(b,"##myFarms")},logOut(){this.farmsPositionObj={},this.farmsUserUsd={},this.farmsRewardObj={},this.farmsPositionList=[],this.farmsAllPositionLoading=!1,this.myFarmsPoolList=[]}}});export{to as u};
