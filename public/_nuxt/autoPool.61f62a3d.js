import{a6 as Y,l as z,T as G,a7 as H}from"./entry.7571a32d.js";import{c,a as Q}from"./sha256.a0451fc3.js";import{I as X,C as F,e as Z,J as T,l as K,u as N,b as J,a as D,s as h,f as W,p as $}from"./pool.1a3e48d7.js";import{C as oo,V as C}from"./index.56c6e888.js";import{D as l}from"./decimal.0e8aa3f1.js";function M(o){const s={launchpad:c[o||"Sui"].launchpad,ido:c[o||"Sui"].ido,xcetus:c[o||"Sui"].xcetus,xcetus_dividends:c[o||"Sui"].xcetus_dividends,cetus_faucet:c[o||"Sui"].cetus_faucet,xtoken:c[o||"Sui"].xtoken,xtoken_dividends:c[o||"Sui"].xtoken_dividends,token_faucet:c[o||"Sui"].token_faucet,booster:c[o||"Sui"].booster,maker_bonus:c[o||"Sui"].maker_bonus,liquidity_stratefy:c[o||"Sui"].liquidity_stratefy,vaults:c[o||"Sui"].vaults},m={fullRpcUrl:localStorage.getItem(`${o}-currentRpclocal2`)||c[o||"Sui"].fullRpcUrl,simulationAccount:c[o||"Sui"].simulationAccount,cetus_config:c[o||"Sui"].cetus_config,clmm_pool:c[o||"Sui"].clmm_pool,integrate:c[o||"Sui"].integrate,deepbook:c[o||"Sui"].deepbook,deepbook_endpoint_v2:c[o||"Sui"].deepbook_endpoint_v2,aggregatorUrl:c[o||"Sui"].aggregatorUrl},i=new X(m),n=Y(new oo(s,i)),a=Q(),f=z(()=>a);G(()=>{f.value.address&&(i.senderAddress=f.value.address)});const j=async()=>{console.log(n,"sdk###");const t=await n.Vaults.getVaultList();return t&&t.data||[]},B=async t=>await n.Vaults.getVault(t),A=async t=>{if(console.log(t,"###coinType"),i.senderAddress){const _=await n.ClmmSDK.fullClient.getBalance({owner:i.senderAddress,coinType:t});return _&&_.totalBalance}else return 0},e=t=>({transactionBlock:t,options:{showEffects:!0,showEvents:!0,showInput:!0,showRawInput:!0,showObjectChanges:!0,showBalanceChanges:!0}});return{getAutoPools:j,getLpBalance:A,deposit:async t=>{const{lowerTick:_,upperTick:x,coinAmount:d,fix_amount_a:g,slippage:y,curSqrtPrice:b,rewarder_coin_types:I}=t;console.log(t,"params###");const S=F.estLiquidityAndcoinAmountFromOneAmounts(_,x,d,g,!0,y,b),k=g?d.toString():S.tokenMaxA.toString(),u=g?S.tokenMaxB.toString():d.toString(),p=await n.Vaults.deposit({vault_id:t.id,clmm_pool:t.clmm_pool,lp_token_type:t.lp_token_type,amount_a:k,amount_b:u,fix_amount_a:g,slippage:y,coinTypeA:t.coinTypeA,coinTypeB:t.coinTypeB,rewarder_coin_types:[]});return e(p)},remove:async t=>{const{lowerSqrtPrice:_,upperSqrtPrice:x,lpTokenAmount:d,curSqrtPrice:g,slippage:y,rewarder_coin_types:b,id:I}=t;console.log(t.lpTokenAmount.toString(),"params##");const S=await B(I),k=await i.Pool.getPool(S.pool_id),u=F.getCoinAmountFromLiquidity(d,new Z(k.current_sqrt_price),_,x,!1),p=T(u.coinA.toString()).mul(T(1-y)),P=T(u.coinB.toString()).mul(T(1-y));console.log(u.coinA.toString(),"##.toString()"),console.log(t.lpTokenAmount.toString(),p.toString(),P.toString(),"params##");const O=C.get_protocol_fee_amount(S,u.coinA.toString()),L=C.get_protocol_fee_amount(S,u.coinB.toString());console.log(S,"##vault"),console.log(k,"newPool##"),console.log(p.toString(),P.toString(),L,O,"###protocol_fee_amount_a");const q=await n.Vaults.remove({vault_id:t.id,clmm_pool:t.clmm_pool,lp_token_type:t.lp_token_type,coinTypeA:t.coinTypeA,coinTypeB:t.coinTypeB,lp_token_amount:d.toString(),min_amount_a:K(T(u.coinA.toString()).sub(O).toString(),0)||"",min_amount_b:K(T(u.coinB.toString()).sub(L).toString(),0)||"",rewarder_coin_types:[]});return e(q)},getAutoPool:B}}const lo=H("autoPool",{state:()=>({autoPoolList:[],autoPoolObj:{},positionInfoObj:{},positionInfoList:[],positionUSDObj:{},apyObj:{}}),getters:{getPoolStore(){return N()}},actions:{async getAutoPoolList(){const s=await M("Sui").getAutoPools();console.log(s,"list###");const m=this.getPoolStore,i=s.map(n=>({...m.poolConfigObj[n.pool_id],id:n.id,lp_token_type:n.lp_token_type,autoPoolPositionInfo:n.positins[0],is_pause:n.is_pause,total_supply:n.total_supply,liquidity:n.liquidity,protocol_fee_rate:n.protocol_fee_rate}));this.autoPoolList=i,this.autoPoolObj=Object.fromEntries(i.map((n,a)=>[n.address,n])),this.getMyAutoPoolPosition(),console.log(i,"##autoPoolList")},async getMyAutoPoolPosition(){var a,f,j,B;const o=M("Sui"),s=this.autoPoolList,m=J("Sui"),i=[],{RATES:n}=this.getPoolStore;for(let A=0;A<s.length;A++){const e=s[A];console.log(e,"poolINfo###");const r=await m.getPool(e.address),w=await o.getLpBalance(s[A].lp_token_type);console.log(w,"balance##");const t=(await m.getTokenListByCoinType([s[A].lp_token_type]))[0];console.log(t,"lpInfo##");const _=((a=n[e.coinA.address])==null?void 0:a.price)||"",x=((f=n[e.coinB.address])==null?void 0:f.price)||"",d=e.autoPoolPositionInfo.tick_lower_index,g=e.autoPoolPositionInfo.tick_upper_index;console.log(s[A],"list[i]"),console.log((j=e==null?void 0:e.object)==null?void 0:j.current_sqrt_price,"##poolInfo?.object?.current_sqrt_price");const y={tick_lower_index:d,tick_upper_index:g,current_sqrt_price:r==null?void 0:r.current_sqrt_price,liquidity:Number(w)>0?C.get_share_liquidity_by_amount({liquidity:e==null?void 0:e.liquidity,total_supply:e==null?void 0:e.total_supply},w):0};console.log(e,"##position");const b=m.getCoinAmountFromLiquidity({pool:{...e,current_sqrt_price:r==null?void 0:r.current_sqrt_price},position:y,roundUp:!1}),I=b.coinaAmount,S=b.coinbAmount;console.log(e.protocol_fee_rate,"##newPoolInfo.protocol_fee_rate");const k=I,u=S,p=new l(_).mul(new l(I)).toNumber(),P=new l(x).mul(new l(S)).toNumber(),O=p>0&&p<.01?"<$0.01":`$${D(h(p,2))}`,L=P>0&&P<.01?"<$0.01":`$${D(h(P,2))}`;let q=0;Number(w)>0&&(q=new l(w).div(Math.pow(10,t.decimals)));const E=_&&x?h(new l(p).add(new l(P)).toString(),2):"",R=e.total_supply;let v=0;q>0&&R>0&&(v=new l(q).mul(Math.pow(10,t.decimals)).div(new l(R)).mul(100).toNumber()),console.log(v,"##myShare");const V=new l(1).div(Math.pow(10,e.decimals)).toNumber();let U=0;v>1?U=h(v,2):v>0&&v<V?U=`<${V}`:v==0?U=0:U=W(v,1),console.log(w,q.toString(),"###balance"),this.positionInfoObj[e.id]={tick_lower_index:d,tick_upper_index:g,current_sqrt_price:r.current_sqrt_price,myLiquidity:$(w,t.decimals),amountA:k,amountB:u,...e,lpInfo:t,myAmountAUSD:O,myAmountBUSD:L,myLiquidityUSD:E,myShare:U},i.push({tick_lower_index:d,tick_upper_index:g,current_sqrt_price:(B=e==null?void 0:e.object)==null?void 0:B.current_sqrt_price,myLiquidity:$(w,t.decimals),amountA:k,amountB:u,...e,lpInfo:t,myAmountAUSD:O,myAmountBUSD:L,myLiquidityUSD:E,myShare:U})}this.positionInfoList=i,console.log(this.positionInfoObj,"this.positionInfoObj###"),console.log(this.positionInfoList,"###this.positionInfoList")},async updatePositionItem(o){var L,q;const s=M("Sui"),m=J("Sui"),i=await s.getAutoPool(o),n=await m.getPool(i.pool_id);console.log("newPoolInfo:",i),console.log("this.positionInfoObj[id]:",this.positionInfoObj[o]);const a={...this.positionInfoObj[o],autoPoolPositionInfo:i.positins[0]},f=await s.getLpBalance(a.lp_token_type),j=(await m.getTokenListByCoinType([a.lp_token_type]))[0];console.log(f,"###balance updatePositionItem");const B=a.autoPoolPositionInfo.tick_lower_index,A=a.autoPoolPositionInfo.tick_upper_index,e={tick_lower_index:B,tick_upper_index:A,current_sqrt_price:n.object.current_sqrt_price,liquidity:C.get_share_liquidity_by_amount({liquidity:i==null?void 0:i.liquidity,total_supply:i==null?void 0:i.total_supply},f)},r=m.getCoinAmountFromLiquidity({pool:{current_sqrt_price:n.current_sqrt_price,...a},position:e,roundUp:!1});console.log(r,"amountInfo###"),r.coinaAmount,r.coinbAmount;const w=r.coinaAmount,t=r.coinbAmount,{RATES:_}=this.getPoolStore,x=i.total_supply,d=((L=_[a.coinA.address])==null?void 0:L.price)||0,g=((q=_[a.coinB.address])==null?void 0:q.price)||0,y=new l(d).mul(new l(r==null?void 0:r.coinaAmount)).toNumber(),b=new l(g).mul(new l(r==null?void 0:r.coinbAmount)).toNumber(),I=y>0&&y<.01?"<$0.01":`$${D(h(y,2))}`,S=b>0&&b<.01?"<$0.01":`$${D(h(b,2))}`;let k=new l(0);Number(f)>0&&(k=new l(f).div(Math.pow(10,j.decimals)));const u=new l(k).mul(Math.pow(10,a.lpInfo.decimals)).div(new l(x)).mul(100).toNumber();let p=0;const P=new l(1).div(Math.pow(10,a.decimals)).toNumber(),O=d&&g?h(new l(y).add(new l(b)).toString(),2):"";u>1?p=h(u,2):u>0&&u<P?p=`<${P}`:p=W(u,1),this.positionInfoObj[o]={...a,tick_lower_index:B,tick_upper_index:A,current_sqrt_price:n.current_sqrt_price,myLiquidity:$(f,j.decimals),amountA:w,amountB:t,myShare:p,myAmountAUSD:I,myAmountBUSD:S,myLiquidityUSD:O},console.log(this.positionInfoObj[o],"###this.positionInfoObj[id]")},async getAutoPoolAPY(){try{const{data:o}=await fetch(`${c.Sui.api}/v2/sui/auto_pools`).then(s=>s.json());o&&o.pools&&o.pools.length>0&&(this.apyObj=Object.fromEntries(o.pools.map((s,m)=>[s.object_id,{...s,apr:s.apr.replace("%","")>0&&s.apr.replace("%","")<.01?"<0.01%":h(s.apr.replace("%",""),2)+"%",resultApr:s.apr.replace("%","")}])),console.log(this.apyObj,"data##"))}catch{this.apyObj={}}}}});export{M as a,lo as u};
