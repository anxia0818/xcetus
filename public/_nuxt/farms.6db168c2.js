import{a7 as X}from"./entry.d9991fb0.js";import{u as z,e as E,m as D,T as C}from"./pool.53213768.js";import{D as t}from"./decimal.0bdeb344.js";const Q=X("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},totalRwadrdUsd:"",farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return z()}},actions:{async getFarmsPoolList(){this.farmsPoolListLoading=!0;const n=await E("Sui").getLpList(),e=Object.fromEntries(n.map((i,a)=>[i.address,i]));console.log(e,"cmmLpObj##");const g=await D("Sui").getFramsPoolList();console.log("getFarmsPoolList:",g);const L=g.map(i=>{const a=e[i.clmm_pool_id];let _=0;const{tokensObj:A}=this.getPoolStore,r=i.rewarders.map(l=>{const m=l.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":l.reward_coin,P=A[m].decimals;return _=_+Number(l.allocate_point),{...l,reward_coin:m,emission_per_day:new t(l.emission_per_second).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,P)).toString()}}),s=a.coinA.decimals,u=a.coinB.decimals,o=C.tickIndexToPrice(i.effective_tick_lower,s,u).toString(),c=C.tickIndexToPrice(i.effective_tick_upper,s,u).toString();return console.log(_,"allocatePoint##"),{...i,minPrice:o,maxPrice:c,fee:a.fee*100+"%",coinA:a.coinA,coinB:a.coinB,rewarders:r,status:_>0?"Live":"Ended"}});console.log("getFarmsPoolList",L),this.farmsPoolList=L,this.farmsPoolObj=Object.fromEntries(g.map(i=>[i.clmm_pool_id,{...i,address:i.clmm_pool_id}])),this.cmmPoolInfoObj=e,this.farmsPoolListLoading=!1},async getPositionByPool(w,n,e){var r,s;this.farmsLoadingObj[n]=!0;const d=E("Sui"),g=D("Sui");console.log(w,n,"#account, poolAddress");const i=(await g.getOwnedFramsPositionNFTList(!0)).filter(u=>u.clmm_pool_id==n),a=await d.getPositionList(w,{address:{address:n}})||[],_=i.concat(a);console.log(i,a,"###farmingPositionList"),console.log(_,"###positionGroup"),this.farmsUserUsd[n]={amount:new t(0),positionNum:0};const A=[];for(let u=0;u<_.length;u++){const o=_[u],c=this.cmmPoolInfoObj[o.clmm_pool_id||o.pool];console.log(c,"##poolInfo");const l=c.coinA.decimals,m=c.coinB.decimals;let P,S;o.tick_lower_index==d.TickUtil.getMinIndex(Number(c.tick_spacing))?P="0":P=d.TickMath.tickIndexToPrice(Number(o.tick_lower_index),l,m).toString(),o.tick_upper_index==d.TickUtil.getMaxIndex(Number(c.tick_spacing))?S="∞":S=d.TickMath.tickIndexToPrice(Number(o.tick_upper_index),l,m).toString(),console.log(o,"#position.clmm_pool_id");let h;const U=await d.getPool(o.clmm_pool_id||o.pool),R=C.sqrtPriceX64ToPrice(U.current_sqrt_price,l,m).toString();Number(R)>=Number(P)&&(S==="∞"||Number(R)<=Number(S))?h="Active":(Number(R)>Number(S)||Number(R)<Number(P))&&(h="Inactive");const M=d.getCoinAmountFromLiquidity({pool:U,position:o,roundUp:!1}),{RATES:O,tokensObj:v}=this.getPoolStore;console.log(O,"##cmmPoolStore");const k=((r=O[c.coinA.address])==null?void 0:r.price)||"",j=((s=O[c.coinB.address])==null?void 0:s.price)||"",T=new t(M.coinaAmount).div(Math.pow(10,l)),y=new t(M.coinbAmount).div(Math.pow(10,m)),I=new t(M.coinaAmount).div(Math.pow(10,l)).mul(k),f=new t(M.coinbAmount).div(Math.pow(10,m)).mul(j);o.rewards&&o.rewards.length>0?o.rewards=o.rewards.map(p=>{console.log(p,o,"reward##171");const N=p.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":p.reward_type,B=v[N],x=O[N].price,F=new t(p.rewarder_amount).div(new t(Math.pow(10,B.decimals)));console.log(F,x,"amount,rewardPrice");const q=F.mul(new t(x)),G=this.farmsRewardObj[o.clmm_pool_id]||{amountUsd:new t(0)};return this.farmsRewardObj[o.clmm_pool_id]?this.farmsRewardObj[o.clmm_pool_id].amountUsd=this.farmsRewardObj[o.clmm_pool_id].amountUsd.add(q):(this.farmsRewardObj[o.clmm_pool_id]=G,this.farmsRewardObj[o.clmm_pool_id].amountUsd=new t(0).add(q)),console.log(this.farmsRewardObj,"##farmsRewardObj"),this.totalRwadrdUsd=new t(this.totalRwadrdUsd).add(q),{...p,rewarderAmount:F.toString(),rewarderAmountUsd:q.toString(),rewarderType:N}}):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let b;if(o.id){const p=I.add(f),N=this.farmsUserUsd[o.clmm_pool_id]||{amount:new t(0),positionNum:0};this.farmsUserUsd[o.clmm_pool_id]?(this.farmsUserUsd[o.clmm_pool_id].amount=this.farmsUserUsd[o.clmm_pool_id].amount.add(p),this.farmsUserUsd[o.clmm_pool_id].positionNum+=1):(this.farmsUserUsd[o.clmm_pool_id]=N,this.farmsUserUsd[o.clmm_pool_id].amount=this.farmsUserUsd[o.clmm_pool_id].amount.add(p),this.farmsUserUsd[o.clmm_pool_id].positionNum+=1),console.log(o,"potision###");const B=this.farmsPoolObj[o.clmm_pool_id];b=g.calculatePositionShare(o,B,U.current_sqrt_price),console.log(b,"##positionShare")}A.push({...o,minPrice:P,maxPrice:S,positionUSD:I.add(f).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:h,positionSource:o.creator?"clmm":"farming",farmsPoolId:e,coinA:c.coinA,coinB:c.coinB,positionShare:b,amountAUsd:I,amountBUsd:f,amountA:T,amountB:y})}this.farmsPositionObj[n]=A,this.farmsLoadingObj[n]=!1},async getPositionByAllPool(w){var _,A;this.farmsAllPositionLoading=!0;const n=D("Sui"),e=E("Sui");this.farmsUserUsd={},this.totalRwadrdUsd=0;const d=await n.getOwnedFramsPositionNFTList(!0),g=await e.getPositionList(w,this.farmsPoolObj)||[];console.log(g,"###clmmPositionList");const L=d.concat(g);console.log(L,"##positionGroup");const i=[];for(let r=0;r<L.length;r++){const s=L[r],u=await e.getPool(s.clmm_pool_id||s.pool),o=e.getCoinAmountFromLiquidity({pool:u,position:s,roundUp:!1}),{RATES:c,tokensObj:l}=this.getPoolStore,m=this.cmmPoolInfoObj[s.clmm_pool_id||s.pool],P=((_=c[m.coinA.address])==null?void 0:_.price)||"",S=((A=c[m.coinB.address])==null?void 0:A.price)||"",h=m.coinA.decimals,U=m.coinB.decimals,R=new t(o.coinaAmount).div(Math.pow(10,h)),M=new t(o.coinbAmount).div(Math.pow(10,U)),O=new t(o.coinaAmount).div(Math.pow(10,h)).mul(P),v=new t(o.coinbAmount).div(Math.pow(10,U)).mul(S);let k,j;s.tick_lower_index==e.TickUtil.getMinIndex(Number(m.tick_spacing))?k="0":k=e.TickMath.tickIndexToPrice(Number(s.tick_lower_index),h,U).toString(),s.tick_upper_index==e.TickUtil.getMaxIndex(Number(m.tick_spacing))?j="∞":j=e.TickMath.tickIndexToPrice(Number(s.tick_upper_index),h,U).toString();let T;const y=C.sqrtPriceX64ToPrice(u.current_sqrt_price,h,U).toString();Number(y)>=Number(k)&&(j==="∞"||Number(y)<=Number(j))?T="Active":(Number(y)>Number(j)||Number(y)<Number(k))&&(T="Inactive");let I;if(s.id){const f=O.add(v),b=this.farmsUserUsd[s.clmm_pool_id]||{amount:new t(0),positionNum:0};this.farmsUserUsd[s.clmm_pool_id]?(this.farmsUserUsd[s.clmm_pool_id].amount=this.farmsUserUsd[s.clmm_pool_id].amount.add(f),this.farmsUserUsd[s.clmm_pool_id].positionNum+=1):(this.farmsUserUsd[s.clmm_pool_id]=b,this.farmsUserUsd[s.clmm_pool_id].amount=this.farmsUserUsd[s.clmm_pool_id].amount.add(f),this.farmsUserUsd[s.clmm_pool_id].positionNum+=1),console.log(s,"potision###");const p=this.farmsPoolObj[s.clmm_pool_id];I=n.calculatePositionShare(s,p,u.current_sqrt_price),console.log(I,"##positionShare")}s.rewards&&s.rewards.length>0&&(s.rewards=s.rewards.map(f=>{const b=f.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":f.reward_type,p=l[b],N=c[b].price,B=new t(f.rewarder_amount).div(new t(Math.pow(10,p.decimals))),x=B.mul(new t(N)),F=this.farmsRewardObj[s.clmm_pool_id]||{amountUsd:new t(0)};return this.farmsRewardObj[s.clmm_pool_id]?this.farmsRewardObj[s.clmm_pool_id].amountUsd=this.farmsRewardObj[s.clmm_pool_id].amountUsd.add(x):(this.farmsRewardObj[s.clmm_pool_id]=F,this.farmsRewardObj[s.clmm_pool_id].amountUsd=new t(0).add(x)),this.totalRwadrdUsd=new t(this.totalRwadrdUsd).add(x),{...f,rewarderAmount:B.toString(),rewarderAmountUsd:x.toString(),rewarderType:b}})),i.push({...s,minPrice:k,maxPrice:j,positionUSD:O.add(v).toNumber(),clmmPool:s.clmm_pool_id||s.pool,positionStatus:T,positionSource:s.creator?"clmm":"farming",farmsPoolId:s.id,coinA:m.coinA,coinB:m.coinB,soucrce:s.id?"farming":"clmm",positionShare:I,amountAUsd:O,amountBUsd:v,amountA:R,amountB:M})}this.farmsPositionList=i;const a={};i.forEach(r=>{a[r.clmm_pool_id||r.pool]||(a[r.clmm_pool_id||r.pool]=[]),a[r.clmm_pool_id||r.pool].push(r)}),this.farmsPositionObj=a,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),this.getMyFarms()},getMyFarms(){const w=[];this.farmsPoolList.forEach(n=>{console.log(this.farmsPositionObj[n.clmm_pool_id],"this.this.farmsPositionObj[##");const e=this.farmsPositionObj[n.clmm_pool_id]&&this.farmsPositionObj[n.clmm_pool_id].filter(d=>d.positionSource=="farming");console.log(e,"getMyFarmsresult##"),e&&e.length>0&&w.push(n)}),this.myFarmsPoolList=w,console.log(w,"##myFarms")}}});export{Q as u};
