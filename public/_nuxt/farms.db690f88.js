import{a7 as V}from"./entry.4f0b5ffa.js";import{u as W,e as H,m as J,T as z}from"./pool.5a57375c.js";import{D as e}from"./decimal.0bdeb344.js";const K=V("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},totalRwadrdUsd:"",farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return W()}},actions:{async getFarmsPoolList(){this.farmsPoolListLoading=!0;const d=await H("Sui").getLpList(),m=Object.fromEntries(d.map((c,n)=>[c.address,c]));console.log(m,"cmmLpObj##");const L=await J("Sui").getFramsPoolList();console.log("getFarmsPoolList:",L);const I=L.map(c=>{const n=m[c.clmm_pool_id];let a=0;const{tokensObj:l}=this.getPoolStore,r=c.rewarders.map(o=>{const s=o.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":o.reward_coin,t=l[s].decimals,u=l[s].symbol;a=a+Number(o.allocate_point);const O=new e(o.allocate_point).div(new e(o.total_allocate_point));return{...o,reward_coin:s,emission_per_day:Number(o.allocate_point)>0?new e(o.emission_per_second).mul(O).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,t)).toString():"0",symbol:u}}),_=n.coinA.decimals,b=n.coinB.decimals,h=z.tickIndexToPrice(c.effective_tick_lower,_,b).toString(),i=z.tickIndexToPrice(c.effective_tick_upper,_,b).toString();return console.log(a,"allocatePoint##"),{...c,minPrice:h,maxPrice:i,fee:n.fee*100+"%",coinA:n.coinA,coinB:n.coinB,rewarders:r,status:a>0?"Live":"Ended"}});console.log("getFarmsPoolList",I),this.farmsPoolList=I,this.farmsPoolObj=Object.fromEntries(I.map(c=>[c.clmm_pool_id,{...c,address:c.clmm_pool_id}])),this.cmmPoolInfoObj=m,this.farmsPoolListLoading=!1},async getPositionByPool(j,d,m){var i,o;this.farmsLoadingObj[d]=!0;const g=H("Sui"),L=J("Sui");console.log(j,d,"#account, poolAddress");const c=(await L.getOwnedFramsPositionNFTList(!0)).filter(s=>s.clmm_pool_id==d),n=await g.getPositionList(j,{address:{address:d}})||[],a=c.concat(n);console.log(c,n,"###farmingPositionList"),console.log(a,"###positionGroup");const l={},r={},_=[];for(let s=0;s<a.length;s++){const t=a[s],u=this.cmmPoolInfoObj[t.clmm_pool_id||t.pool];console.log(u,"##poolInfo");const O=u.coinA.decimals,p=u.coinB.decimals;let B,N;t.tick_lower_index==g.TickUtil.getMinIndex(Number(u.tick_spacing))?B="0":B=g.TickMath.tickIndexToPrice(Number(t.tick_lower_index),O,p).toString(),t.tick_upper_index==g.TickUtil.getMaxIndex(Number(u.tick_spacing))?N="∞":N=g.TickMath.tickIndexToPrice(Number(t.tick_upper_index),O,p).toString(),console.log(t,"#position.clmm_pool_id");let P;const S=await g.getPool(t.clmm_pool_id||t.pool),E=z.sqrtPriceX64ToPrice(S.current_sqrt_price,O,p).toString();Number(E)>=Number(B)&&(N==="∞"||Number(E)<=Number(N))?P="Active":(Number(E)>Number(N)||Number(E)<Number(B))&&(P="Inactive");const k=g.getCoinAmountFromLiquidity({pool:S,position:t,roundUp:!1}),{RATES:x,tokensObj:q}=this.getPoolStore;console.log(x,"##cmmPoolStore");const M=((i=x[u.coinA.address])==null?void 0:i.price)||"",R=((o=x[u.coinB.address])==null?void 0:o.price)||"",C=new e(k.coinaAmount).div(Math.pow(10,O)),D=new e(k.coinbAmount).div(Math.pow(10,p)),T=new e(k.coinaAmount).div(Math.pow(10,O)).mul(M),v=new e(k.coinbAmount).div(Math.pow(10,p)).mul(R);let w=new e(0);t.rewards&&t.rewards.length>0?t.rewards=t.rewards.map(f=>{var Q;console.log(f,t,"reward##171");const F=f.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":f.rewarder_type,X=q[F];console.log(q,"##tokensObj");const A=((Q=x[F])==null?void 0:Q.price)||0,G=new e(f.rewarder_amount).div(new e(Math.pow(10,X.decimals)));console.log(G,A,"amount,rewardPrice");const y=G.mul(new e(A));return console.log(y.toString(),"rewarderAmountUsd"),r[t.clmm_pool_id]&&r[t.clmm_pool_id][t.id]?r[t.clmm_pool_id][t.id]=r[t.clmm_pool_id][t.id].add(y):r[t.clmm_pool_id]&&!r[t.clmm_pool_id][t.id]?(r[t.clmm_pool_id][t.id]={},r[t.clmm_pool_id][t.id]=y):(r[t.clmm_pool_id]={},r[t.clmm_pool_id][t.id]={},r[t.clmm_pool_id][t.id]=y),console.log(this.farmsRewardObj,"##farmsRewardObj"),w=w.add(y),{...f,rewarderAmount:G.toString(),rewarderAmountUsd:y.toString(),rewarderType:F}}):(t.rewards=[],this.farmsRewardObj[t.clmm_pool_id]={});let U;if(t.id){const f=T.add(v);l[t.clmm_pool_id]||(l[t.clmm_pool_id]={}),l[t.clmm_pool_id][t.id]=f,console.log(t,"potision###");const F=this.farmsPoolObj[t.clmm_pool_id];U=L.calculatePositionShare(t,F,S.current_sqrt_price),console.log(U,"##positionShare")}console.log(this.farmsUserUsd,"##this.farmsUserUsd"),_.push({...t,minPrice:B,maxPrice:N,positionUSD:T.add(v).toNumber(),clmmPool:t.clmm_pool_id||t.pool,positionStatus:P,positionSource:t.creator?"clmm":"farming",farmsPoolId:m,coinA:u.coinA,coinB:u.coinB,positionShare:U,amountAUsd:T,amountBUsd:v,amountA:C,amountB:D,positionRewardAmount:w})}const b={};Object.keys(r).forEach(s=>{b[s]={},b[s].amountUsd=new e(0),typeof r[s]=="object"&&Object.keys(r[s]).forEach(t=>{console.log(t,r[s][t],"#######375"),b[s].amountUsd=b[s].amountUsd.add(r[s][t])})});const h={};Object.keys(l).forEach(s=>{h[s]={},h[s].amount=new e(0),h[s].positionNum=0,typeof l[s]=="object"&&Object.keys(l[s]).forEach(t=>{h[s].amount=h[s].amount.add(l[s][t]),h[s].positionNum+=1})}),console.log("farmsUserUsd:",l),this.farmsRewardObj={...this.farmsRewardObj,...b},this.farmsUserUsd={...this.farmsUserUsd,...h},this.farmsPositionObj[d]=_,this.farmsLoadingObj[d]=!1},async getPositionByAllPool(j){var b,h;this.farmsAllPositionLoading=!0;const d=J("Sui"),m=H("Sui");this.totalRwadrdUsd=0;const g=await d.getOwnedFramsPositionNFTList(!0),L=await m.getPositionList(j,this.farmsPoolObj)||[];console.log(L,"###clmmPositionList");const I=g.concat(L);console.log(I,"##positionGroup");const c=[],n={},a={};for(let i=0;i<I.length;i++){const o=I[i],s=await m.getPool(o.clmm_pool_id||o.pool),t=m.getCoinAmountFromLiquidity({pool:s,position:o,roundUp:!1}),{RATES:u,tokensObj:O}=this.getPoolStore,p=this.cmmPoolInfoObj[o.clmm_pool_id||o.pool],B=((b=u[p.coinA.address])==null?void 0:b.price)||"",N=((h=u[p.coinB.address])==null?void 0:h.price)||"",P=p.coinA.decimals,S=p.coinB.decimals,E=new e(t.coinaAmount).div(Math.pow(10,P)),k=new e(t.coinbAmount).div(Math.pow(10,S)),x=new e(t.coinaAmount).div(Math.pow(10,P)).mul(B),q=new e(t.coinbAmount).div(Math.pow(10,S)).mul(N);let M,R;o.tick_lower_index==m.TickUtil.getMinIndex(Number(p.tick_spacing))?M="0":M=m.TickMath.tickIndexToPrice(Number(o.tick_lower_index),P,S).toString(),o.tick_upper_index==m.TickUtil.getMaxIndex(Number(p.tick_spacing))?R="∞":R=m.TickMath.tickIndexToPrice(Number(o.tick_upper_index),P,S).toString();let C;const D=z.sqrtPriceX64ToPrice(s.current_sqrt_price,P,S).toString();Number(D)>=Number(M)&&(R==="∞"||Number(D)<=Number(R))?C="Active":(Number(D)>Number(R)||Number(D)<Number(M))&&(C="Inactive");let T;if(o.id){const w=x.add(q);a[o.clmm_pool_id]||(a[o.clmm_pool_id]={}),a[o.clmm_pool_id][o.id]=w,console.log(o,"potision###");const U=this.farmsPoolObj[o.clmm_pool_id];T=d.calculatePositionShare(o,U,s.current_sqrt_price),console.log(T,"##positionShare")}let v=new e(0);o.rewards&&o.rewards.length>0&&(o.rewards=o.rewards.map(w=>{var G;console.log(w,"#reward292");const U=w.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":w.rewarder_type,f=O[U];console.log(f,U,"tokenInfo##294");const F=((G=u[U])==null?void 0:G.price)||0,X=new e(w.rewarder_amount).div(new e(Math.pow(10,f==null?void 0:f.decimals))),A=X.mul(new e(F));return n[o.clmm_pool_id]&&n[o.clmm_pool_id][o.id]?n[o.clmm_pool_id][o.id]=n[o.clmm_pool_id][o.id].add(A):n[o.clmm_pool_id]&&!n[o.clmm_pool_id][o.id]?(n[o.clmm_pool_id][o.id]={},n[o.clmm_pool_id][o.id]=A):(n[o.clmm_pool_id]={},n[o.clmm_pool_id][o.id]={},n[o.clmm_pool_id][o.id]=A),this.totalRwadrdUsd=new e(this.totalRwadrdUsd).add(A),v=v.add(A),{...w,rewarderAmount:X.toString(),rewarderAmountUsd:A.toString(),rewarderType:U}})),c.push({...o,minPrice:M,maxPrice:R,positionUSD:x.add(q).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:C,positionSource:o.creator?"clmm":"farming",farmsPoolId:o.pool_id,coinA:p.coinA,coinB:p.coinB,soucrce:o.id?"farming":"clmm",positionShare:T,amountAUsd:x.toString(),amountBUsd:q.toString(),amountA:E.toString(),amountB:k.toString(),positionRewardAmount:v})}this.farmsPositionList=c;const l={};c.forEach(i=>{l[i.clmm_pool_id||i.pool]||(l[i.clmm_pool_id||i.pool]=[]),l[i.clmm_pool_id||i.pool].push(i)}),this.farmsPositionObj=l,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),console.log(n,"##this.farmsRewardObj");const r={};Object.keys(n).forEach(i=>{console.log(n,i,"farmsRewardObj:"),r[i]={},r[i].amountUsd=new e(0),typeof n[i]=="object"&&Object.keys(n[i]).forEach(o=>{console.log(n[i][o].toString(),"#######375"),r[i].amountUsd=r[i].amountUsd.add(n[i][o]),console.log(r[i].amountUsd.toString(),"result[key].amountUsd.toString()")})});const _={};Object.keys(a).forEach(i=>{_[i]={},_[i].amount=new e(0),_[i].positionNum=0,typeof a[i]=="object"&&Object.keys(a[i]).forEach(o=>{_[i].amount=_[i].amount.add(a[i][o]),_[i].positionNum+=1})}),console.log("farmsUserUsd:",a),console.log(this.totalRwadrdUsd,"this.totalRwadrdUsd###"),this.farmsRewardObj=r,this.farmsUserUsd=_,console.log(this.farmsRewardObj,"##this.farmsRewardObj"),this.getMyFarms()},getMyFarms(){const j=[];this.farmsPoolList.forEach(d=>{console.log(this.farmsPositionObj[d.clmm_pool_id],"this.this.farmsPositionObj[##");const m=this.farmsPositionObj[d.clmm_pool_id]&&this.farmsPositionObj[d.clmm_pool_id].filter(g=>g.positionSource=="farming");console.log(m,"getMyFarmsresult##"),m&&m.length>0&&j.push(d)}),this.myFarmsPoolList=j,console.log(j,"##myFarms")},logOut(){this.farmsPositionObj={},this.farmsUserUsd={},this.farmsRewardObj={},this.totalRwadrdUsd="",this.farmsPositionList=[],this.farmsAllPositionLoading=!1,this.myFarmsPoolList=[]}}});export{K as u};
