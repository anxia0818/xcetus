import{a7 as z}from"./entry.13a3203d.js";import{u as H,e as E,m as D,T as C}from"./pool.8bdcf583.js";import{D as s}from"./decimal.0bdeb344.js";const V=z("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},totalRwadrdUsd:"",farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return H()}},actions:{async getFarmsPoolList(){this.farmsPoolListLoading=!0;const r=await E("Sui").getLpList(),e=Object.fromEntries(r.map((i,a)=>[i.address,i]));console.log(e,"cmmLpObj##");const U=await D("Sui").getFramsPoolList();console.log("getFarmsPoolList:",U);const L=U.map(i=>{const a=e[i.clmm_pool_id];let f=0;const{tokensObj:k}=this.getPoolStore,n=i.rewarders.map(d=>{const m=d.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":d.reward_coin,P=k[m].decimals;return f=f+Number(d.allocate_point),{...d,reward_coin:m,emission_per_day:Number(d.allocate_point)>0?new s(d.emission_per_second).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,P)).toString():"0"}}),t=a.coinA.decimals,p=a.coinB.decimals,o=C.tickIndexToPrice(i.effective_tick_lower,t,p).toString(),c=C.tickIndexToPrice(i.effective_tick_upper,t,p).toString();return console.log(f,"allocatePoint##"),{...i,minPrice:o,maxPrice:c,fee:a.fee*100+"%",coinA:a.coinA,coinB:a.coinB,rewarders:n,status:f>0?"Live":"Ended"}});console.log("getFarmsPoolList",L),this.farmsPoolList=L,this.farmsPoolObj=Object.fromEntries(U.map(i=>[i.clmm_pool_id,{...i,address:i.clmm_pool_id}])),this.cmmPoolInfoObj=e,this.farmsPoolListLoading=!1},async getPositionByPool(w,r,e){var n,t;this.farmsLoadingObj[r]=!0;const u=E("Sui"),U=D("Sui");console.log(w,r,"#account, poolAddress");const i=(await U.getOwnedFramsPositionNFTList(!0)).filter(p=>p.clmm_pool_id==r),a=await u.getPositionList(w,{address:{address:r}})||[],f=i.concat(a);console.log(i,a,"###farmingPositionList"),console.log(f,"###positionGroup"),this.farmsUserUsd[r]={amount:new s(0),positionNum:0};const k=[];for(let p=0;p<f.length;p++){const o=f[p],c=this.cmmPoolInfoObj[o.clmm_pool_id||o.pool];console.log(c,"##poolInfo");const d=c.coinA.decimals,m=c.coinB.decimals;let P,S;o.tick_lower_index==u.TickUtil.getMinIndex(Number(c.tick_spacing))?P="0":P=u.TickMath.tickIndexToPrice(Number(o.tick_lower_index),d,m).toString(),o.tick_upper_index==u.TickUtil.getMaxIndex(Number(c.tick_spacing))?S="∞":S=u.TickMath.tickIndexToPrice(Number(o.tick_upper_index),d,m).toString(),console.log(o,"#position.clmm_pool_id");let h;const b=await u.getPool(o.clmm_pool_id||o.pool),B=C.sqrtPriceX64ToPrice(b.current_sqrt_price,d,m).toString();Number(B)>=Number(P)&&(S==="∞"||Number(B)<=Number(S))?h="Active":(Number(B)>Number(S)||Number(B)<Number(P))&&(h="Inactive");const M=u.getCoinAmountFromLiquidity({pool:b,position:o,roundUp:!1}),{RATES:O,tokensObj:T}=this.getPoolStore;console.log(O,"##cmmPoolStore");const N=((n=O[c.coinA.address])==null?void 0:n.price)||"",j=((t=O[c.coinB.address])==null?void 0:t.price)||"",y=new s(M.coinaAmount).div(Math.pow(10,d)),v=new s(M.coinbAmount).div(Math.pow(10,m)),I=new s(M.coinaAmount).div(Math.pow(10,d)).mul(N),_=new s(M.coinbAmount).div(Math.pow(10,m)).mul(j);o.rewards&&o.rewards.length>0?o.rewards=o.rewards.map(l=>{var G;console.log(l,o,"reward##171");const x=l.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":l.rewarder_type,F=T[x];console.log(T,"##tokensObj");const R=((G=O[x])==null?void 0:G.price)||0,q=new s(l.rewarder_amount).div(new s(Math.pow(10,F.decimals)));console.log(q,R,"amount,rewardPrice");const A=q.mul(new s(R));console.log(A.toString(),"rewarderAmountUsd");const X=this.farmsRewardObj[o.clmm_pool_id]||{amountUsd:new s(0)};return this.farmsRewardObj[o.clmm_pool_id]?this.farmsRewardObj[o.clmm_pool_id].amountUsd=this.farmsRewardObj[o.clmm_pool_id].amountUsd.add(A):(this.farmsRewardObj[o.clmm_pool_id]=X,this.farmsRewardObj[o.clmm_pool_id].amountUsd=new s(0).add(A)),console.log(this.farmsRewardObj,"##farmsRewardObj"),this.totalRwadrdUsd=new s(this.totalRwadrdUsd).add(A),{...l,rewarderAmount:q.toString(),rewarderAmountUsd:A.toString(),rewarderType:x}}):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let g;if(o.id){const l=I.add(_),x=this.farmsUserUsd[o.clmm_pool_id]||{amount:new s(0),positionNum:0};this.farmsUserUsd[o.clmm_pool_id]?(this.farmsUserUsd[o.clmm_pool_id].amount=this.farmsUserUsd[o.clmm_pool_id].amount.add(l),this.farmsUserUsd[o.clmm_pool_id].positionNum+=1):(this.farmsUserUsd[o.clmm_pool_id]=x,this.farmsUserUsd[o.clmm_pool_id].amount=this.farmsUserUsd[o.clmm_pool_id].amount.add(l),this.farmsUserUsd[o.clmm_pool_id].positionNum+=1),console.log(o,"potision###");const F=this.farmsPoolObj[o.clmm_pool_id];g=U.calculatePositionShare(o,F,b.current_sqrt_price),console.log(g,"##positionShare")}k.push({...o,minPrice:P,maxPrice:S,positionUSD:I.add(_).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:h,positionSource:o.creator?"clmm":"farming",farmsPoolId:e,coinA:c.coinA,coinB:c.coinB,positionShare:g,amountAUsd:I,amountBUsd:_,amountA:y,amountB:v})}this.farmsPositionObj[r]=k,this.farmsLoadingObj[r]=!1},async getPositionByAllPool(w){var f,k;this.farmsAllPositionLoading=!0;const r=D("Sui"),e=E("Sui");this.farmsUserUsd={},this.totalRwadrdUsd=0;const u=await r.getOwnedFramsPositionNFTList(!0),U=await e.getPositionList(w,this.farmsPoolObj)||[];console.log(U,"###clmmPositionList");const L=u.concat(U);console.log(L,"##positionGroup");const i=[];for(let n=0;n<L.length;n++){const t=L[n],p=await e.getPool(t.clmm_pool_id||t.pool),o=e.getCoinAmountFromLiquidity({pool:p,position:t,roundUp:!1}),{RATES:c,tokensObj:d}=this.getPoolStore,m=this.cmmPoolInfoObj[t.clmm_pool_id||t.pool],P=((f=c[m.coinA.address])==null?void 0:f.price)||"",S=((k=c[m.coinB.address])==null?void 0:k.price)||"",h=m.coinA.decimals,b=m.coinB.decimals,B=new s(o.coinaAmount).div(Math.pow(10,h)),M=new s(o.coinbAmount).div(Math.pow(10,b)),O=new s(o.coinaAmount).div(Math.pow(10,h)).mul(P),T=new s(o.coinbAmount).div(Math.pow(10,b)).mul(S);let N,j;t.tick_lower_index==e.TickUtil.getMinIndex(Number(m.tick_spacing))?N="0":N=e.TickMath.tickIndexToPrice(Number(t.tick_lower_index),h,b).toString(),t.tick_upper_index==e.TickUtil.getMaxIndex(Number(m.tick_spacing))?j="∞":j=e.TickMath.tickIndexToPrice(Number(t.tick_upper_index),h,b).toString();let y;const v=C.sqrtPriceX64ToPrice(p.current_sqrt_price,h,b).toString();Number(v)>=Number(N)&&(j==="∞"||Number(v)<=Number(j))?y="Active":(Number(v)>Number(j)||Number(v)<Number(N))&&(y="Inactive");let I;if(t.id){const _=O.add(T),g=this.farmsUserUsd[t.clmm_pool_id]||{amount:new s(0),positionNum:0};this.farmsUserUsd[t.clmm_pool_id]?(this.farmsUserUsd[t.clmm_pool_id].amount=this.farmsUserUsd[t.clmm_pool_id].amount.add(_),this.farmsUserUsd[t.clmm_pool_id].positionNum+=1):(this.farmsUserUsd[t.clmm_pool_id]=g,this.farmsUserUsd[t.clmm_pool_id].amount=this.farmsUserUsd[t.clmm_pool_id].amount.add(_),this.farmsUserUsd[t.clmm_pool_id].positionNum+=1),console.log(t,"potision###");const l=this.farmsPoolObj[t.clmm_pool_id];I=r.calculatePositionShare(t,l,p.current_sqrt_price),console.log(I,"##positionShare")}t.rewards&&t.rewards.length>0&&(t.rewards=t.rewards.map(_=>{var A;console.log(_,"#reward292");const g=_.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":_.rewarder_type,l=d[g];console.log(l,g,"tokenInfo##294");const x=((A=c[g])==null?void 0:A.price)||0,F=new s(_.rewarder_amount).div(new s(Math.pow(10,l==null?void 0:l.decimals))),R=F.mul(new s(x)),q=this.farmsRewardObj[t.clmm_pool_id]||{amountUsd:new s(0)};return this.farmsRewardObj[t.clmm_pool_id]?this.farmsRewardObj[t.clmm_pool_id].amountUsd=this.farmsRewardObj[t.clmm_pool_id].amountUsd.add(R):(this.farmsRewardObj[t.clmm_pool_id]=q,this.farmsRewardObj[t.clmm_pool_id].amountUsd=new s(0).add(R)),this.totalRwadrdUsd=new s(this.totalRwadrdUsd).add(R),{..._,rewarderAmount:F.toString(),rewarderAmountUsd:R.toString(),rewarderType:g}})),i.push({...t,minPrice:N,maxPrice:j,positionUSD:O.add(T).toNumber(),clmmPool:t.clmm_pool_id||t.pool,positionStatus:y,positionSource:t.creator?"clmm":"farming",farmsPoolId:t.id,coinA:m.coinA,coinB:m.coinB,soucrce:t.id?"farming":"clmm",positionShare:I,amountAUsd:O.toString(),amountBUsd:T.toString(),amountA:B.toString(),amountB:M.toString()})}this.farmsPositionList=i;const a={};i.forEach(n=>{a[n.clmm_pool_id||n.pool]||(a[n.clmm_pool_id||n.pool]=[]),a[n.clmm_pool_id||n.pool].push(n)}),this.farmsPositionObj=a,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),this.getMyFarms()},getMyFarms(){const w=[];this.farmsPoolList.forEach(r=>{console.log(this.farmsPositionObj[r.clmm_pool_id],"this.this.farmsPositionObj[##");const e=this.farmsPositionObj[r.clmm_pool_id]&&this.farmsPositionObj[r.clmm_pool_id].filter(u=>u.positionSource=="farming");console.log(e,"getMyFarmsresult##"),e&&e.length>0&&w.push(r)}),this.myFarmsPoolList=w,console.log(w,"##myFarms")}}});export{V as u};
