import{a6 as so,l as co,T as lo,a7 as uo}from"./entry.53f4a2f5.js";import{c as a,a as ro}from"./sha256.6423b3a5.js";import{I as ao,e as O,C as G,l as to,J as eo,u as po,b as no,a as z,s as x,T as _o,K as io,p as H}from"./pool.e4675898.js";import{C as mo,V as F}from"./index.d8d5f7f5.js";import{D as n}from"./decimal.0e8aa3f1.js";function Q(t){const l={launchpad:a[t||"Sui"].launchpad,ido:a[t||"Sui"].ido,xcetus:a[t||"Sui"].xcetus,xcetus_dividends:a[t||"Sui"].xcetus_dividends,cetus_faucet:a[t||"Sui"].cetus_faucet,xtoken:a[t||"Sui"].xtoken,xtoken_dividends:a[t||"Sui"].xtoken_dividends,token_faucet:a[t||"Sui"].token_faucet,booster:a[t||"Sui"].booster,maker_bonus:a[t||"Sui"].maker_bonus,liquidity_stratefy:a[t||"Sui"].liquidity_stratefy,vaults:a[t||"Sui"].vaults},A={fullRpcUrl:localStorage.getItem(`${t}-currentRpclocal2`)||a[t||"Sui"].fullRpcUrl,simulationAccount:a[t||"Sui"].simulationAccount,cetus_config:a[t||"Sui"].cetus_config,clmm_pool:a[t||"Sui"].clmm_pool,integrate:a[t||"Sui"].integrate,deepbook:a[t||"Sui"].deepbook,deepbook_endpoint_v2:a[t||"Sui"].deepbook_endpoint_v2,aggregatorUrl:a[t||"Sui"].aggregatorUrl},c=new ao(A),i=so(new mo(l,c)),m=ro(),q=co(()=>m);lo(()=>{q.value.address&&(c.senderAddress=q.value.address)});const M=async()=>{console.log(i,"sdk###");const o=await i.Vaults.getVaultList();return o&&o.data||[]},j=async o=>await i.Vaults.getVault(o),B=async o=>{if(console.log(o,"###coinType"),c.senderAddress){const p=await i.ClmmSDK.fullClient.getBalance({owner:c.senderAddress,coinType:o});return p&&p.totalBalance}else return 0},e=o=>({transactionBlock:o,options:{showEffects:!0,showEvents:!0,showInput:!0,showRawInput:!0,showObjectChanges:!0,showBalanceChanges:!0}});return{getAutoPools:M,getLpBalance:B,deposit:async o=>{const{lowerTick:p,upperTick:d,slippage:g,rewarder_coin_types:S,isOnlyA:f,isOnlyB:b}=o;console.log(o,"params###");let _=o.fix_amount_a,u,r,P;if(f||b){const I=await i.Vaults.calculateDepositSwapAmount({lowerTick:p,upperTick:d,curSqrtPrice:o.curSqrtPrice,fix_amount_a:o.fix_amount_a,input_amount:o.coinAmount,coinTypeA:o.coinTypeA,coinTypeB:o.coinTypeB,clmm_pool:o.clmm_pool});console.log("swapResut: ",I),I?(r=new O(I.afterSqrtPrice),u=new O(I.swapOutAmount),r=new O(o.curSqrtPrice),P={swap_amount:I.swapInAmount,a2b:_},_=!_):(r=new O(o.curSqrtPrice),u=new O(o.coinAmount))}else r=o.curSqrtPrice,u=new O(o.coinAmount);const D=G.estLiquidityAndcoinAmountFromOneAmounts(p,d,u,_,!0,g,r),U=_?u.toString():D.tokenMaxA.toString(),h=_?D.tokenMaxB.toString():u.toString(),C=await i.Vaults.deposit({vault_id:o.id,clmm_pool:o.clmm_pool,lp_token_type:o.lp_token_type,amount_a:U,amount_b:h,fix_amount_a:_,slippage:g,coinTypeA:o.coinTypeA,coinTypeB:o.coinTypeB,rewarder_coin_types:[],swapParams:P});return e(C)},remove:async o=>{const{lowerTick:p,upperTick:d,coinTypeA:g,coinTypeB:S,receiveAmount:f,clmm_pool:b,lowerSqrtPrice:_,upperSqrtPrice:u,fix_amount_a:r,curSqrtPrice:P,slippage:D,rewarder_coin_types:U,id:h,liquidity:C,swapParams:I,isOnlyA:W,isOnlyB:E}=o,k=await j(h),L=await c.Pool.getPool(k.pool_id);let y,w,K,N,R;console.log(f,"##receiveAmount"),W||E?(y=await i.Vaults.calculateRemoveSwapAmount({lowerTick:p,upperTick:d,curSqrtPrice:L.current_sqrt_price,fix_amount_a:r,receive_amount:f,coinTypeA:g,coinTypeB:S,clmm_pool:b}),console.log(y,"swapResut###"),y&&(w=G.getCoinAmountFromLiquidity(new O(y.liquidity),new O(L.current_sqrt_price),_,u,!1),K=F.get_protocol_fee_amount(k,w.coinA.toString()),N=F.get_protocol_fee_amount(k,w.coinB.toString()),R=F.get_lp_amount_by_liquidity(k,y.liquidity))):(w=G.getCoinAmountFromLiquidity(new O(C),P,_,u,!1),K=F.get_protocol_fee_amount(k,w.coinA.toString()),N=F.get_protocol_fee_amount(k,w.coinB.toString()),R=o.lpTokenAmount);const X={vault_id:o.id,clmm_pool:o.clmm_pool,lp_token_type:o.lp_token_type,coinTypeA:o.coinTypeA,coinTypeB:o.coinTypeB,lp_token_amount:R.toString(),min_amount_a:to(eo(w.coinA.toString()).sub(K).toString(),0)||"",min_amount_b:to(eo(w.coinB.toString()).sub(N).toString(),0)||"",rewarder_coin_types:[]};(W||E)&&(X.swapParams={a2b:!r,swap_amount:y==null?void 0:y.swapInAmount});const Y=await i.Vaults.remove(X);return e(Y)},getAutoPool:j,calculateDepositSwapAmount:async o=>{const{lowerTick:p,upperTick:d,curSqrtPrice:g,fix_amount_a:S,input_amount:f,coinTypeA:b,coinTypeB:_,clmm_pool:u}=o;return console.log(o,"params###"),await i.Vaults.calculateDepositSwapAmount({lowerTick:p,upperTick:d,curSqrtPrice:g,fix_amount_a:S,input_amount:f,coinTypeA:b,coinTypeB:_,clmm_pool:u})},calculateRemoveSwapAmount:async o=>{const{lowerTick:p,upperTick:d,curSqrtPrice:g,fix_amount_a:S,receiveAmount:f,coinTypeA:b,coinTypeB:_,clmm_pool:u}=o;return console.log(o,"params###"),await i.Vaults.calculateRemoveSwapAmount({lowerTick:p,upperTick:d,curSqrtPrice:g,fix_amount_a:S,receive_amount:f,coinTypeA:b,coinTypeB:_,clmm_pool:u})}}}const fo=uo("autoPool",{state:()=>({autoPoolList:[],autoPoolObj:{},positionInfoObj:{},positionInfoList:[],positionUSDObj:{},apyObj:{}}),getters:{getPoolStore(){return po()}},actions:{async getAutoPoolList(){const l=await Q("Sui").getAutoPools();console.log(l,"list###");const A=this.getPoolStore,c=l.map(i=>({...A.poolConfigObj[i.pool_id],id:i.id,lp_token_type:i.lp_token_type,autoPoolPositionInfo:i.positins[0],is_pause:i.is_pause,total_supply:i.total_supply,liquidity:i.liquidity,protocol_fee_rate:i.protocol_fee_rate}));this.autoPoolList=c,this.autoPoolObj=Object.fromEntries(c.map((i,m)=>[i.address,i])),this.getMyAutoPoolPosition(),console.log(c,"##autoPoolList")},async getMyAutoPoolPosition(){var m,q,M,j;const t=Q("Sui"),l=this.autoPoolList,A=no("Sui"),c=[],{RATES:i}=this.getPoolStore;for(let B=0;B<l.length;B++){const e=l[B];console.log(e,"poolINfo###");const s=await A.getPool(e.address),T=await t.getLpBalance(l[B].lp_token_type);console.log(T,"balance##");const v=(await A.getTokenListByCoinType([l[B].lp_token_type]))[0];console.log(v,"lpInfo##");const V=((m=i[e.coinA.address])==null?void 0:m.price)||"",o=((q=i[e.coinB.address])==null?void 0:q.price)||"",p=e.autoPoolPositionInfo.tick_lower_index,d=e.autoPoolPositionInfo.tick_upper_index;console.log(l[B],"list[i]"),console.log((M=e==null?void 0:e.object)==null?void 0:M.current_sqrt_price,"##poolInfo?.object?.current_sqrt_price");const g={tick_lower_index:p,tick_upper_index:d,current_sqrt_price:s==null?void 0:s.current_sqrt_price,liquidity:Number(T)>0?F.get_share_liquidity_by_amount({liquidity:e==null?void 0:e.liquidity,total_supply:e==null?void 0:e.total_supply},T):0};console.log(e,"##position");const S=await A.getCoinAmountFromLiquidity({pool:{...e,current_sqrt_price:s==null?void 0:s.current_sqrt_price},position:g,roundUp:!1});console.log(S,"##amountInfo");const f=S.coinaAmount,b=S.coinbAmount;console.log(e.protocol_fee_rate,"##newPoolInfo.protocol_fee_rate");const _=f,u=b,r=e.coinA.decimals,P=e.coinB.decimals,D=A.TickMath.tickIndexToPrice(Number(p),r,P).toString(),U=A.TickMath.tickIndexToPrice(Number(d),r,P).toString(),h=new n(V).mul(new n(f)).toNumber(),C=new n(o).mul(new n(b)).toNumber(),I=h>0&&h<.01?"<$0.01":`$${z(x(h,2))}`,W=C>0&&C<.01?"<$0.01":`$${z(x(C,2))}`,E=_o.sqrtPriceX64ToPrice(s.current_sqrt_price,r,P);let k,L;const y=new n(s.coinAmountA).div(new n(Math.pow(10,r))).toNumber(),w=new n(s.coinAmountB).div(new n(Math.pow(10,P))).toNumber();console.log(y,w,E.toString(),"###116");const K=x(new n(y).mul(new n(V)).toNumber(),r),N=x(new n(w).mul(new n(o)).toNumber(),P);if(console.log(s,"newPool##"),y>0&&w>0){const oo=new n(y).mul(E).add(new n(w));k=new n(y).mul(E).div(oo).mul(100).toNumber().toFixed(2),L=new n(w).div(oo).mul(100).toNumber().toFixed(2)}else f>0?(k=100,L=0):b>0?(k=0,L=100):(k=50,L=50);let R=0;Number(T)>0&&(R=new n(T).div(Math.pow(10,v.decimals)));const X=V&&o?x(new n(h).add(new n(C)).toString(),2):"",Y=e.total_supply;let $=0;R>0&&Y>0&&($=new n(R).mul(Math.pow(10,v.decimals)).div(new n(Y)).mul(100).toNumber()),console.log($,"##myShare");const Z=new n(1).div(Math.pow(10,e.decimals)).toNumber();let J=0;$>1?J=x($,2):$>0&&$<Z?J=`<${Z}`:$==0?J=0:J=io($,1),console.log(T,R.toString(),"###balance"),this.positionInfoObj[e.id]={tick_lower_index:p,tick_upper_index:d,current_sqrt_price:s.current_sqrt_price,myLiquidity:H(T,v.decimals),amountA:_,amountB:u,...e,lpInfo:v,myAmountAUSD:I,myAmountBUSD:W,myLiquidityUSD:X,myShare:J,minPrice:D,maxPrice:U,poolCoinARatio:k,poolCoinBRatio:L,poolCoinANum:y,poolCoinBNum:w,poolCoinAUSD:K,poolCoinBUSD:N},c.push({tick_lower_index:p,tick_upper_index:d,current_sqrt_price:(j=e==null?void 0:e.object)==null?void 0:j.current_sqrt_price,myLiquidity:H(T,v.decimals),amountA:_,amountB:u,...e,lpInfo:v,myAmountAUSD:I,myAmountBUSD:W,myLiquidityUSD:X,myShare:J,minPrice:D,maxPrice:U,poolCoinARatio:k,poolCoinBRatio:L,poolCoinANum:y,poolCoinBNum:w,poolCoinAUSD:K,poolCoinBUSD:N})}this.positionInfoList=c,console.log(this.positionInfoObj,"this.positionInfoObj###"),console.log(this.positionInfoList,"###this.positionInfoList")},async updatePositionItem(t){var U,h;const l=Q("Sui"),A=no("Sui"),c=await l.getAutoPool(t),i=await A.getPool(c.pool_id);console.log("newPoolInfo:",c),console.log("this.positionInfoObj[id]:",this.positionInfoObj[t]);const m={...this.positionInfoObj[t],autoPoolPositionInfo:c.positins[0]},q=await l.getLpBalance(m.lp_token_type),M=(await A.getTokenListByCoinType([m.lp_token_type]))[0];console.log(q,"###balance updatePositionItem");const j=m.autoPoolPositionInfo.tick_lower_index,B=m.autoPoolPositionInfo.tick_upper_index,e={tick_lower_index:j,tick_upper_index:B,current_sqrt_price:i.current_sqrt_price,liquidity:F.get_share_liquidity_by_amount({liquidity:c==null?void 0:c.liquidity,total_supply:c==null?void 0:c.total_supply},q)},s=A.getCoinAmountFromLiquidity({pool:{current_sqrt_price:i.current_sqrt_price,...m},position:e,roundUp:!1});console.log(s,"amountInfo###"),s.coinaAmount,s.coinbAmount;const T=s.coinaAmount,v=s.coinbAmount,{RATES:V}=this.getPoolStore,o=c.total_supply,p=((U=V[m.coinA.address])==null?void 0:U.price)||0,d=((h=V[m.coinB.address])==null?void 0:h.price)||0,g=new n(p).mul(new n(s==null?void 0:s.coinaAmount)).toNumber(),S=new n(d).mul(new n(s==null?void 0:s.coinbAmount)).toNumber(),f=g>0&&g<.01?"<$0.01":`$${z(x(g,2))}`,b=S>0&&S<.01?"<$0.01":`$${z(x(S,2))}`;let _=new n(0);Number(q)>0&&(_=new n(q).div(Math.pow(10,M.decimals)));const u=new n(_).mul(Math.pow(10,m.lpInfo.decimals)).div(new n(o)).mul(100).toNumber();let r=0;const P=new n(1).div(Math.pow(10,m.decimals)).toNumber(),D=p&&d?x(new n(g).add(new n(S)).toString(),2):"";u>1?r=x(u,2):u>0&&u<P?r=`<${P}`:r=io(u,1),this.positionInfoObj[t]={...m,tick_lower_index:j,tick_upper_index:B,current_sqrt_price:i.current_sqrt_price,myLiquidity:H(q,M.decimals),amountA:T,amountB:v,myShare:r,myAmountAUSD:f,myAmountBUSD:b,myLiquidityUSD:D},console.log(this.positionInfoObj[t],"###this.positionInfoObj[id]")},async getAutoPoolAPY(){try{const{data:t}=await fetch(`${a.Sui.api}/v2/sui/auto_pools`).then(l=>l.json());t&&t.pools&&t.pools.length>0&&(this.apyObj=Object.fromEntries(t.pools.map((l,A)=>[l.object_id,{...l,apr:l.apr.replace("%","")>0&&l.apr.replace("%","")<.01?"<0.01%":x(l.apr.replace("%",""),2)+"%",resultApr:l.apr.replace("%","")}])),console.log(this.apyObj,"data##"))}catch{this.apyObj={}}}}});export{Q as a,fo as u};
