import{a7 as X}from"./entry.234eaa43.js";import{u as z,e as E,m as D,T as C}from"./pool.7c4b57b4.js";import{D as t}from"./decimal.0bdeb344.js";const Q=X("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},totalRwadrdUsd:"",farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return z()}},actions:{async getFarmsPoolList(){this.farmsPoolListLoading=!0;const e=await E("Sui").getLpList(),c=Object.fromEntries(e.map((i,m)=>[i.address,i]));console.log(c,"cmmLpObj##");const g=await D("Sui").getFramsPoolList();console.log("getFarmsPoolList:",g);const j=g.map(i=>{const m=c[i.clmm_pool_id];let u=0;const{tokensObj:A}=this.getPoolStore,r=i.rewarders.map(l=>{const n=l.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":l.reward_coin,U=A[n].decimals;return u=u+Number(l.allocate_point),{...l,reward_coin:n,emission_per_day:new t(l.emission_per_second).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,U)).toString()}}),s=m.coinA.decimals,d=m.coinB.decimals,o=C.tickIndexToPrice(i.effective_tick_lower,s,d).toString(),a=C.tickIndexToPrice(i.effective_tick_upper,s,d).toString();return console.log(u,"allocatePoint##"),{...i,minPrice:o,maxPrice:a,fee:m.fee*100+"%",coinA:m.coinA,coinB:m.coinB,rewarders:r,status:u>0?"Live":"Ended"}});console.log("getFarmsPoolList",j),this.farmsPoolList=j,this.farmsPoolObj=Object.fromEntries(g.map(i=>[i.clmm_pool_id,{...i,address:i.clmm_pool_id}])),this.cmmPoolInfoObj=c,this.farmsPoolListLoading=!1},async getPositionByPool(w,e,c){var r,s;this.farmsLoadingObj[e]=!0;const f=E("Sui"),g=D("Sui");console.log(w,e,"#account, poolAddress");const i=(await g.getOwnedFramsPositionNFTList(!0)).filter(d=>d.clmm_pool_id==e),m=await f.getPositionList(w,{address:{address:e}})||[],u=i.concat(m);console.log(i,m,"###farmingPositionList"),console.log(u,"###positionGroup"),this.farmsUserUsd[e]={amount:new t(0),positionNum:0};const A=[];for(let d=0;d<u.length;d++){const o=u[d],a=this.cmmPoolInfoObj[o.clmm_pool_id||o.pool];console.log(a,"##poolInfo");const l=a.coinA.decimals,n=a.coinB.decimals;let U,S;o.tick_lower_index==f.TickUtil.getMinIndex(Number(a.tick_spacing))?U="0":U=f.TickMath.tickIndexToPrice(Number(o.tick_lower_index),l,n).toString(),o.tick_upper_index==f.TickUtil.getMaxIndex(Number(a.tick_spacing))?S="∞":S=f.TickMath.tickIndexToPrice(Number(o.tick_upper_index),l,n).toString(),console.log(o,"#position.clmm_pool_id");let h;const P=await f.getPool(o.clmm_pool_id||o.pool),R=C.sqrtPriceX64ToPrice(P.current_sqrt_price,l,n).toString();Number(R)>=Number(U)&&(S==="∞"||Number(R)<=Number(S))?h="Active":(Number(R)>Number(S)||Number(R)<Number(U))&&(h="Inactive");const T=f.getCoinAmountFromLiquidity({pool:P,position:o,roundUp:!1}),{RATES:L,tokensObj:y}=this.getPoolStore;console.log(L,"##cmmPoolStore");const k=((r=L[a.coinA.address])==null?void 0:r.price)||"",O=((s=L[a.coinB.address])==null?void 0:s.price)||"",M=new t(T.coinaAmount).div(Math.pow(10,l)),B=new t(T.coinbAmount).div(Math.pow(10,n)),I=new t(T.coinaAmount).div(Math.pow(10,l)).mul(k),_=new t(T.coinbAmount).div(Math.pow(10,n)).mul(O);o.rewards&&o.rewards.length>0?o.rewards=o.rewards.map(p=>{console.log(p,o,"reward##171");const N=p.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":p.reward_type,v=y[N],x=L[N].price,F=new t(p.rewarder_amount).div(new t(Math.pow(10,v.decimals)));console.log(F,x,"amount,rewardPrice");const q=F.mul(new t(x)),G=this.farmsRewardObj[o.clmm_pool_id]||{amountUsd:new t(0)};return this.farmsRewardObj[o.clmm_pool_id]?this.farmsRewardObj[o.clmm_pool_id].amountUsd=this.farmsRewardObj[o.clmm_pool_id].amountUsd.add(q):(this.farmsRewardObj[o.clmm_pool_id]=G,this.farmsRewardObj[o.clmm_pool_id].amountUsd=new t(0).add(q)),console.log(this.farmsRewardObj,"##farmsRewardObj"),this.totalRwadrdUsd=new t(this.totalRwadrdUsd).add(q),{...p,rewarderAmount:F.toString(),rewarderAmountUsd:q.toString(),rewarderType:N}}):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let b;if(o.id){const p=I.add(_),N=this.farmsUserUsd[o.clmm_pool_id]||{amount:new t(0),positionNum:0};this.farmsUserUsd[o.clmm_pool_id]?(this.farmsUserUsd[o.clmm_pool_id].amount=this.farmsUserUsd[o.clmm_pool_id].amount.add(p),this.farmsUserUsd[o.clmm_pool_id].positionNum+=1):(this.farmsUserUsd[o.clmm_pool_id]=N,this.farmsUserUsd[o.clmm_pool_id].amount=this.farmsUserUsd[o.clmm_pool_id].amount.add(p),this.farmsUserUsd[o.clmm_pool_id].positionNum+=1),console.log(o,"potision###");const v=this.farmsPoolObj[o.clmm_pool_id];b=g.calculatePositionShare(o,v,P.current_sqrt_price),console.log(b,"##positionShare")}A.push({...o,minPrice:U,maxPrice:S,positionUSD:I.add(_).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:h,positionSource:o.creator?"clmm":"farming",farmsPoolId:c,coinA:a.coinA,coinB:a.coinB,positionShare:b,amountAUsd:I,amountBUsd:_,amountA:M,amountB:B})}this.farmsPositionObj[e]=A,this.farmsLoadingObj[e]=!1},async getPositionByAllPool(w){var u,A;this.farmsAllPositionLoading=!0;const e=D("Sui"),c=E("Sui");this.farmsUserUsd={},this.totalRwadrdUsd=0;const f=await e.getOwnedFramsPositionNFTList(!0),g=await c.getPositionList(w,this.farmsPoolObj)||[];console.log(g,"###clmmPositionList");const j=f.concat(g);console.log(j,"##positionGroup");const i=[];for(let r=0;r<j.length;r++){const s=j[r],d=await c.getPool(s.clmm_pool_id||s.pool),o=c.getCoinAmountFromLiquidity({pool:d,position:s,roundUp:!1}),{RATES:a,tokensObj:l}=this.getPoolStore,n=this.cmmPoolInfoObj[s.clmm_pool_id||s.pool],U=((u=a[n.coinA.address])==null?void 0:u.price)||"",S=((A=a[n.coinB.address])==null?void 0:A.price)||"",h=n.coinA.decimals,P=n.coinB.decimals,R=new t(o.coinaAmount).div(Math.pow(10,h)),T=new t(o.coinbAmount).div(Math.pow(10,P)),L=new t(o.coinaAmount).div(Math.pow(10,h)).mul(U),y=new t(o.coinbAmount).div(Math.pow(10,P)).mul(S);let k,O;s.tick_lower_index==c.TickUtil.getMinIndex(Number(n.tick_spacing))?k="0":k=c.TickMath.tickIndexToPrice(Number(s.tick_lower_index),h,P).toString(),s.tick_upper_index==c.TickUtil.getMaxIndex(Number(n.tick_spacing))?O="∞":O=c.TickMath.tickIndexToPrice(Number(s.tick_upper_index),h,P).toString();let M;const B=C.sqrtPriceX64ToPrice(d.current_sqrt_price,h,P).toString();Number(B)>=Number(k)&&(O==="∞"||Number(B)<=Number(O))?M="Active":(Number(B)>Number(O)||Number(B)<Number(k))&&(M="Inactive");let I;if(s.id){const _=L.add(y),b=this.farmsUserUsd[s.clmm_pool_id]||{amount:new t(0),positionNum:0};this.farmsUserUsd[s.clmm_pool_id]?(this.farmsUserUsd[s.clmm_pool_id].amount=this.farmsUserUsd[s.clmm_pool_id].amount.add(_),this.farmsUserUsd[s.clmm_pool_id].positionNum+=1):(this.farmsUserUsd[s.clmm_pool_id]=b,this.farmsUserUsd[s.clmm_pool_id].amount=this.farmsUserUsd[s.clmm_pool_id].amount.add(_),this.farmsUserUsd[s.clmm_pool_id].positionNum+=1),console.log(s,"potision###");const p=this.farmsPoolObj[s.clmm_pool_id];I=e.calculatePositionShare(s,p,d.current_sqrt_price),console.log(I,"##positionShare")}s.rewards&&s.rewards.length>0&&(s.rewards=s.rewards.map(_=>{const b=_.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":_.reward_type,p=l[b],N=a[b].price,v=new t(_.rewarder_amount).div(new t(Math.pow(10,p.decimals))),x=v.mul(new t(N)),F=this.farmsRewardObj[s.clmm_pool_id]||{amountUsd:new t(0)};return this.farmsRewardObj[s.clmm_pool_id]?this.farmsRewardObj[s.clmm_pool_id].amountUsd=this.farmsRewardObj[s.clmm_pool_id].amountUsd.add(x):(this.farmsRewardObj[s.clmm_pool_id]=F,this.farmsRewardObj[s.clmm_pool_id].amountUsd=new t(0).add(x)),this.totalRwadrdUsd=new t(this.totalRwadrdUsd).add(x),{..._,rewarderAmount:v.toString(),rewarderAmountUsd:x.toString(),rewarderType:b}})),i.push({...s,minPrice:k,maxPrice:O,positionUSD:L.add(y).toNumber(),clmmPool:s.clmm_pool_id||s.pool,positionStatus:M,positionSource:s.creator?"clmm":"farming",farmsPoolId:s.id,coinA:n.coinA,coinB:n.coinB,soucrce:s.id?"farming":"clmm",positionShare:I,amountAUsd:L,amountBUsd:y,amountA:R,amountB:T})}this.farmsPositionList=i;const m={};i.forEach(r=>{m[r.clmm_pool_id||r.pool]||(m[r.clmm_pool_id||r.pool]=[]),m[r.clmm_pool_id||r.pool].push(r)}),this.farmsPositionObj=m,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),this.getMyFarms()},getMyFarms(){const w=[];this.farmsPoolList.forEach(e=>{this.farmsPositionObj[e.clmm_pool_id]&&w.push(e)}),this.myFarmsPoolList=w,console.log(w,"##myFarms")}}});export{Q as u};
