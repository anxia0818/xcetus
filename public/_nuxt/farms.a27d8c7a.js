import{a7 as V}from"./entry.ebd4a795.js";import{u as W,e as H,m as J,T as z}from"./pool.1ed2be8f.js";import{D as n}from"./decimal.0bdeb344.js";const K=V("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},totalRwadrdUsd:"",farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return W()}},actions:{async getFarmsPoolList(){this.farmsPoolListLoading=!0;const d=await H("Sui").getLpList(),a=Object.fromEntries(d.map((e,r)=>[e.address,e]));console.log(a,"cmmLpObj##");const S=await J("Sui").getFramsPoolList();console.log("getFarmsPoolList:",S);const A=S.map(e=>{const r=a[e.clmm_pool_id];let c=0;const{tokensObj:m}=this.getPoolStore,l=e.rewarders.map(o=>{const s=o.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":o.reward_coin,t=m[s].decimals;c=c+Number(o.allocate_point);const u=new n(o.allocate_point).div(new n(o.total_allocate_point));return{...o,reward_coin:s,emission_per_day:Number(o.allocate_point)>0?new n(o.emission_per_second).mul(u).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,t)).toString():"0"}}),f=r.coinA.decimals,b=r.coinB.decimals,h=z.tickIndexToPrice(e.effective_tick_lower,f,b).toString(),i=z.tickIndexToPrice(e.effective_tick_upper,f,b).toString();return console.log(c,"allocatePoint##"),{...e,minPrice:h,maxPrice:i,fee:r.fee*100+"%",coinA:r.coinA,coinB:r.coinB,rewarders:l,status:c>0?"Live":"Ended"}});console.log("getFarmsPoolList",A),this.farmsPoolList=A,this.farmsPoolObj=Object.fromEntries(A.map(e=>[e.clmm_pool_id,{...e,address:e.clmm_pool_id}])),this.cmmPoolInfoObj=a,this.farmsPoolListLoading=!1},async getPositionByPool(j,d,a){var i,o;this.farmsLoadingObj[d]=!0;const g=H("Sui"),S=J("Sui");console.log(j,d,"#account, poolAddress");const e=(await S.getOwnedFramsPositionNFTList(!0)).filter(s=>s.clmm_pool_id==d),r=await g.getPositionList(j,{address:{address:d}})||[],c=e.concat(r);console.log(e,r,"###farmingPositionList"),console.log(c,"###positionGroup");const m={},l={},f=[];for(let s=0;s<c.length;s++){const t=c[s],u=this.cmmPoolInfoObj[t.clmm_pool_id||t.pool];console.log(u,"##poolInfo");const R=u.coinA.decimals,p=u.coinB.decimals;let B,L;t.tick_lower_index==g.TickUtil.getMinIndex(Number(u.tick_spacing))?B="0":B=g.TickMath.tickIndexToPrice(Number(t.tick_lower_index),R,p).toString(),t.tick_upper_index==g.TickUtil.getMaxIndex(Number(u.tick_spacing))?L="∞":L=g.TickMath.tickIndexToPrice(Number(t.tick_upper_index),R,p).toString(),console.log(t,"#position.clmm_pool_id");let P;const O=await g.getPool(t.clmm_pool_id||t.pool),k=z.sqrtPriceX64ToPrice(O.current_sqrt_price,R,p).toString();Number(k)>=Number(B)&&(L==="∞"||Number(k)<=Number(L))?P="Active":(Number(k)>Number(L)||Number(k)<Number(B))&&(P="Inactive");const E=g.getCoinAmountFromLiquidity({pool:O,position:t,roundUp:!1}),{RATES:I,tokensObj:q}=this.getPoolStore;console.log(I,"##cmmPoolStore");const M=((i=I[u.coinA.address])==null?void 0:i.price)||"",N=((o=I[u.coinB.address])==null?void 0:o.price)||"",C=new n(E.coinaAmount).div(Math.pow(10,R)),D=new n(E.coinbAmount).div(Math.pow(10,p)),T=new n(E.coinaAmount).div(Math.pow(10,R)).mul(M),v=new n(E.coinbAmount).div(Math.pow(10,p)).mul(N);let w=new n(0);t.rewards&&t.rewards.length>0?t.rewards=t.rewards.map(_=>{var Q;console.log(_,t,"reward##171");const F=_.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":_.rewarder_type,y=q[F];console.log(q,"##tokensObj");const x=((Q=I[F])==null?void 0:Q.price)||0,G=new n(_.rewarder_amount).div(new n(Math.pow(10,y.decimals)));console.log(G,x,"amount,rewardPrice");const X=G.mul(new n(x));return console.log(X.toString(),"rewarderAmountUsd"),l[t.clmm_pool_id]||(l[t.clmm_pool_id]={}),l[t.clmm_pool_id][t.id]=X,console.log(this.farmsRewardObj,"##farmsRewardObj"),w=w.add(X),{..._,rewarderAmount:G.toString(),rewarderAmountUsd:X.toString(),rewarderType:F}}):(t.rewards=[],this.farmsRewardObj[t.clmm_pool_id]={});let U;if(t.id){const _=T.add(v);m[t.clmm_pool_id]||(m[t.clmm_pool_id]={}),m[t.clmm_pool_id][t.id]=_,console.log(t,"potision###");const F=this.farmsPoolObj[t.clmm_pool_id];U=S.calculatePositionShare(t,F,O.current_sqrt_price),console.log(U,"##positionShare")}console.log(this.farmsUserUsd,"##this.farmsUserUsd"),f.push({...t,minPrice:B,maxPrice:L,positionUSD:T.add(v).toNumber(),clmmPool:t.clmm_pool_id||t.pool,positionStatus:P,positionSource:t.creator?"clmm":"farming",farmsPoolId:a,coinA:u.coinA,coinB:u.coinB,positionShare:U,amountAUsd:T,amountBUsd:v,amountA:C,amountB:D,positionRewardAmount:w})}const b={};Object.keys(l).forEach(s=>{b[s]={},b[s].amountUsd=new n(0),typeof l[s]=="object"&&Object.keys(l[s]).forEach(t=>{console.log(t,l[s][t],"#######375"),b[s].amountUsd=b[s].amountUsd.add(l[s][t])})});const h={};Object.keys(m).forEach(s=>{h[s]={},h[s].amount=new n(0),h[s].positionNum=0,typeof m[s]=="object"&&Object.keys(m[s]).forEach(t=>{h[s].amount=h[s].amount.add(m[s][t]),h[s].positionNum+=1})}),console.log("farmsUserUsd:",m),this.farmsRewardObj={...this.farmsRewardObj,...b},this.farmsUserUsd={...this.farmsUserUsd,...h},this.farmsPositionObj[d]=f,this.farmsLoadingObj[d]=!1},async getPositionByAllPool(j){var b,h;this.farmsAllPositionLoading=!0;const d=J("Sui"),a=H("Sui");this.totalRwadrdUsd=0;const g=await d.getOwnedFramsPositionNFTList(!0),S=await a.getPositionList(j,this.farmsPoolObj)||[];console.log(S,"###clmmPositionList");const A=g.concat(S);console.log(A,"##positionGroup");const e=[],r={},c={};for(let i=0;i<A.length;i++){const o=A[i],s=await a.getPool(o.clmm_pool_id||o.pool),t=a.getCoinAmountFromLiquidity({pool:s,position:o,roundUp:!1}),{RATES:u,tokensObj:R}=this.getPoolStore,p=this.cmmPoolInfoObj[o.clmm_pool_id||o.pool],B=((b=u[p.coinA.address])==null?void 0:b.price)||"",L=((h=u[p.coinB.address])==null?void 0:h.price)||"",P=p.coinA.decimals,O=p.coinB.decimals,k=new n(t.coinaAmount).div(Math.pow(10,P)),E=new n(t.coinbAmount).div(Math.pow(10,O)),I=new n(t.coinaAmount).div(Math.pow(10,P)).mul(B),q=new n(t.coinbAmount).div(Math.pow(10,O)).mul(L);let M,N;o.tick_lower_index==a.TickUtil.getMinIndex(Number(p.tick_spacing))?M="0":M=a.TickMath.tickIndexToPrice(Number(o.tick_lower_index),P,O).toString(),o.tick_upper_index==a.TickUtil.getMaxIndex(Number(p.tick_spacing))?N="∞":N=a.TickMath.tickIndexToPrice(Number(o.tick_upper_index),P,O).toString();let C;const D=z.sqrtPriceX64ToPrice(s.current_sqrt_price,P,O).toString();Number(D)>=Number(M)&&(N==="∞"||Number(D)<=Number(N))?C="Active":(Number(D)>Number(N)||Number(D)<Number(M))&&(C="Inactive");let T;if(o.id){const w=I.add(q);c[o.clmm_pool_id]||(c[o.clmm_pool_id]={}),c[o.clmm_pool_id][o.id]=w,console.log(o,"potision###");const U=this.farmsPoolObj[o.clmm_pool_id];T=d.calculatePositionShare(o,U,s.current_sqrt_price),console.log(T,"##positionShare")}let v=new n(0);o.rewards&&o.rewards.length>0&&(o.rewards=o.rewards.map(w=>{var G;console.log(w,"#reward292");const U=w.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":w.rewarder_type,_=R[U];console.log(_,U,"tokenInfo##294");const F=((G=u[U])==null?void 0:G.price)||0,y=new n(w.rewarder_amount).div(new n(Math.pow(10,_==null?void 0:_.decimals))),x=y.mul(new n(F));return r[o.clmm_pool_id]||(r[o.clmm_pool_id]={}),r[o.clmm_pool_id][o.id]=x,this.totalRwadrdUsd=new n(this.totalRwadrdUsd).add(x),v=v.add(x),{...w,rewarderAmount:y.toString(),rewarderAmountUsd:x.toString(),rewarderType:U}})),e.push({...o,minPrice:M,maxPrice:N,positionUSD:I.add(q).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:C,positionSource:o.creator?"clmm":"farming",farmsPoolId:o.pool_id,coinA:p.coinA,coinB:p.coinB,soucrce:o.id?"farming":"clmm",positionShare:T,amountAUsd:I.toString(),amountBUsd:q.toString(),amountA:k.toString(),amountB:E.toString(),positionRewardAmount:v})}this.farmsPositionList=e;const m={};e.forEach(i=>{m[i.clmm_pool_id||i.pool]||(m[i.clmm_pool_id||i.pool]=[]),m[i.clmm_pool_id||i.pool].push(i)}),this.farmsPositionObj=m,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),console.log(r,"##this.farmsRewardObj");const l={};Object.keys(r).forEach(i=>{l[i]={},l[i].amountUsd=new n(0),typeof r[i]=="object"&&Object.keys(r[i]).forEach(o=>{console.log(o,r[i][o],"#######375"),l[i].amountUsd=l[i].amountUsd.add(r[i][o])})});const f={};Object.keys(c).forEach(i=>{f[i]={},f[i].amount=new n(0),f[i].positionNum=0,typeof c[i]=="object"&&Object.keys(c[i]).forEach(o=>{f[i].amount=f[i].amount.add(c[i][o]),f[i].positionNum+=1})}),console.log("farmsUserUsd:",c),console.log(this.totalRwadrdUsd,"this.totalRwadrdUsd###"),this.farmsRewardObj=l,this.farmsUserUsd=f,console.log(this.farmsRewardObj,"##this.farmsRewardObj"),this.getMyFarms()},getMyFarms(){const j=[];this.farmsPoolList.forEach(d=>{console.log(this.farmsPositionObj[d.clmm_pool_id],"this.this.farmsPositionObj[##");const a=this.farmsPositionObj[d.clmm_pool_id]&&this.farmsPositionObj[d.clmm_pool_id].filter(g=>g.positionSource=="farming");console.log(a,"getMyFarmsresult##"),a&&a.length>0&&j.push(d)}),this.myFarmsPoolList=j,console.log(j,"##myFarms")},logOut(){this.farmsPositionObj={},this.farmsUserUsd={},this.farmsRewardObj={},this.totalRwadrdUsd="",this.farmsPositionList=[],this.farmsAllPositionLoading=!1,this.myFarmsPoolList=[]}}});export{K as u};
