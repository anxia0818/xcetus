import{a7 as z}from"./entry.0ff498e7.js";import{u as H,e as E,m as D,T as C}from"./pool.31260876.js";import{D as t}from"./decimal.0bdeb344.js";const V=z("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},totalRwadrdUsd:"",farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return H()}},actions:{async getFarmsPoolList(){this.farmsPoolListLoading=!0;const n=await E("Sui").getLpList(),e=Object.fromEntries(n.map((i,a)=>[i.address,i]));console.log(e,"cmmLpObj##");const P=await D("Sui").getFramsPoolList();console.log("getFarmsPoolList:",P);const A=P.map(i=>{const a=e[i.clmm_pool_id];let f=0;const{tokensObj:k}=this.getPoolStore,r=i.rewarders.map(d=>{const m=d.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":d.reward_coin,U=k[m].decimals;return f=f+Number(d.allocate_point),{...d,reward_coin:m,emission_per_day:Number(d.allocate_point)>0?new t(d.emission_per_second).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,U)).toString():"0"}}),s=a.coinA.decimals,p=a.coinB.decimals,o=C.tickIndexToPrice(i.effective_tick_lower,s,p).toString(),c=C.tickIndexToPrice(i.effective_tick_upper,s,p).toString();return console.log(f,"allocatePoint##"),{...i,minPrice:o,maxPrice:c,fee:a.fee*100+"%",coinA:a.coinA,coinB:a.coinB,rewarders:r,status:f>0?"Live":"Ended"}});console.log("getFarmsPoolList",A),this.farmsPoolList=A,this.farmsPoolObj=Object.fromEntries(P.map(i=>[i.clmm_pool_id,{...i,address:i.clmm_pool_id}])),this.cmmPoolInfoObj=e,this.farmsPoolListLoading=!1},async getPositionByPool(g,n,e){var r,s;this.farmsLoadingObj[n]=!0;const u=E("Sui"),P=D("Sui");console.log(g,n,"#account, poolAddress");const i=(await P.getOwnedFramsPositionNFTList(!0)).filter(p=>p.clmm_pool_id==n),a=await u.getPositionList(g,{address:{address:n}})||[],f=i.concat(a);console.log(i,a,"###farmingPositionList"),console.log(f,"###positionGroup"),this.farmsUserUsd[n]={amount:new t(0),positionNum:0};const k=[];for(let p=0;p<f.length;p++){const o=f[p],c=this.cmmPoolInfoObj[o.clmm_pool_id||o.pool];console.log(c,"##poolInfo");const d=c.coinA.decimals,m=c.coinB.decimals;let U,S;o.tick_lower_index==u.TickUtil.getMinIndex(Number(c.tick_spacing))?U="0":U=u.TickMath.tickIndexToPrice(Number(o.tick_lower_index),d,m).toString(),o.tick_upper_index==u.TickUtil.getMaxIndex(Number(c.tick_spacing))?S="∞":S=u.TickMath.tickIndexToPrice(Number(o.tick_upper_index),d,m).toString(),console.log(o,"#position.clmm_pool_id");let h;const b=await u.getPool(o.clmm_pool_id||o.pool),M=C.sqrtPriceX64ToPrice(b.current_sqrt_price,d,m).toString();Number(M)>=Number(U)&&(S==="∞"||Number(M)<=Number(S))?h="Active":(Number(M)>Number(S)||Number(M)<Number(U))&&(h="Inactive");const T=u.getCoinAmountFromLiquidity({pool:b,position:o,roundUp:!1}),{RATES:O,tokensObj:y}=this.getPoolStore;console.log(O,"##cmmPoolStore");const N=((r=O[c.coinA.address])==null?void 0:r.price)||"",j=((s=O[c.coinB.address])==null?void 0:s.price)||"",B=new t(T.coinaAmount).div(Math.pow(10,d)),v=new t(T.coinbAmount).div(Math.pow(10,m)),I=new t(T.coinaAmount).div(Math.pow(10,d)).mul(N),_=new t(T.coinbAmount).div(Math.pow(10,m)).mul(j);o.rewards&&o.rewards.length>0?o.rewards=o.rewards.map(l=>{var G;console.log(l,o,"reward##171");const x=l.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":l.rewarder_type,F=y[x];console.log(y,"##tokensObj");const R=((G=O[x])==null?void 0:G.price)||0,q=new t(l.rewarder_amount).div(new t(Math.pow(10,F.decimals)));console.log(q,R,"amount,rewardPrice");const L=q.mul(new t(R));console.log(L.toString(),"rewarderAmountUsd");const X=this.farmsRewardObj[o.clmm_pool_id]||{amountUsd:new t(0)};return this.farmsRewardObj[o.clmm_pool_id]?this.farmsRewardObj[o.clmm_pool_id].amountUsd=this.farmsRewardObj[o.clmm_pool_id].amountUsd.add(L):(this.farmsRewardObj[o.clmm_pool_id]=X,this.farmsRewardObj[o.clmm_pool_id].amountUsd=new t(0).add(L)),console.log(this.farmsRewardObj,"##farmsRewardObj"),this.totalRwadrdUsd=new t(this.totalRwadrdUsd).add(L),{...l,rewarderAmount:q.toString(),rewarderAmountUsd:L.toString(),rewarderType:x}}):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let w;if(o.id){const l=I.add(_),x=this.farmsUserUsd[o.clmm_pool_id]||{amount:new t(0),positionNum:0};this.farmsUserUsd[o.clmm_pool_id]?(this.farmsUserUsd[o.clmm_pool_id].amount=this.farmsUserUsd[o.clmm_pool_id].amount.add(l),this.farmsUserUsd[o.clmm_pool_id].positionNum+=1):(this.farmsUserUsd[o.clmm_pool_id]=x,this.farmsUserUsd[o.clmm_pool_id].amount=this.farmsUserUsd[o.clmm_pool_id].amount.add(l),this.farmsUserUsd[o.clmm_pool_id].positionNum+=1),console.log(o,"potision###");const F=this.farmsPoolObj[o.clmm_pool_id];w=P.calculatePositionShare(o,F,b.current_sqrt_price),console.log(w,"##positionShare")}k.push({...o,minPrice:U,maxPrice:S,positionUSD:I.add(_).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:h,positionSource:o.creator?"clmm":"farming",farmsPoolId:e,coinA:c.coinA,coinB:c.coinB,positionShare:w,amountAUsd:I,amountBUsd:_,amountA:B,amountB:v})}this.farmsPositionObj[n]=k,this.farmsLoadingObj[n]=!1},async getPositionByAllPool(g){var f,k;this.farmsAllPositionLoading=!0;const n=D("Sui"),e=E("Sui");this.farmsUserUsd={},this.totalRwadrdUsd=0;const u=await n.getOwnedFramsPositionNFTList(!0),P=await e.getPositionList(g,this.farmsPoolObj)||[];console.log(P,"###clmmPositionList");const A=u.concat(P);console.log(A,"##positionGroup");const i=[];for(let r=0;r<A.length;r++){const s=A[r],p=await e.getPool(s.clmm_pool_id||s.pool),o=e.getCoinAmountFromLiquidity({pool:p,position:s,roundUp:!1}),{RATES:c,tokensObj:d}=this.getPoolStore,m=this.cmmPoolInfoObj[s.clmm_pool_id||s.pool],U=((f=c[m.coinA.address])==null?void 0:f.price)||"",S=((k=c[m.coinB.address])==null?void 0:k.price)||"",h=m.coinA.decimals,b=m.coinB.decimals,M=new t(o.coinaAmount).div(Math.pow(10,h)),T=new t(o.coinbAmount).div(Math.pow(10,b)),O=new t(o.coinaAmount).div(Math.pow(10,h)).mul(U),y=new t(o.coinbAmount).div(Math.pow(10,b)).mul(S);let N,j;s.tick_lower_index==e.TickUtil.getMinIndex(Number(m.tick_spacing))?N="0":N=e.TickMath.tickIndexToPrice(Number(s.tick_lower_index),h,b).toString(),s.tick_upper_index==e.TickUtil.getMaxIndex(Number(m.tick_spacing))?j="∞":j=e.TickMath.tickIndexToPrice(Number(s.tick_upper_index),h,b).toString();let B;const v=C.sqrtPriceX64ToPrice(p.current_sqrt_price,h,b).toString();Number(v)>=Number(N)&&(j==="∞"||Number(v)<=Number(j))?B="Active":(Number(v)>Number(j)||Number(v)<Number(N))&&(B="Inactive");let I;if(s.id){const _=O.add(y),w=this.farmsUserUsd[s.clmm_pool_id]||{amount:new t(0),positionNum:0};this.farmsUserUsd[s.clmm_pool_id]?(this.farmsUserUsd[s.clmm_pool_id].amount=this.farmsUserUsd[s.clmm_pool_id].amount.add(_),this.farmsUserUsd[s.clmm_pool_id].positionNum+=1):(this.farmsUserUsd[s.clmm_pool_id]=w,this.farmsUserUsd[s.clmm_pool_id].amount=this.farmsUserUsd[s.clmm_pool_id].amount.add(_),this.farmsUserUsd[s.clmm_pool_id].positionNum+=1),console.log(s,"potision###");const l=this.farmsPoolObj[s.clmm_pool_id];I=n.calculatePositionShare(s,l,p.current_sqrt_price),console.log(I,"##positionShare")}s.rewards&&s.rewards.length>0&&(s.rewards=s.rewards.map(_=>{var L;console.log(_,"#reward292");const w=_.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":_.rewarder_type,l=d[w];console.log(l,w,"tokenInfo##294");const x=((L=c[w])==null?void 0:L.price)||0,F=new t(_.rewarder_amount).div(new t(Math.pow(10,l==null?void 0:l.decimals))),R=F.mul(new t(x)),q=this.farmsRewardObj[s.clmm_pool_id]||{amountUsd:new t(0)};return this.farmsRewardObj[s.clmm_pool_id]?this.farmsRewardObj[s.clmm_pool_id].amountUsd=this.farmsRewardObj[s.clmm_pool_id].amountUsd.add(R):(this.farmsRewardObj[s.clmm_pool_id]=q,this.farmsRewardObj[s.clmm_pool_id].amountUsd=new t(0).add(R)),this.totalRwadrdUsd=new t(this.totalRwadrdUsd).add(R),{..._,rewarderAmount:F.toString(),rewarderAmountUsd:R.toString(),rewarderType:w}})),i.push({...s,minPrice:N,maxPrice:j,positionUSD:O.add(y).toNumber(),clmmPool:s.clmm_pool_id||s.pool,positionStatus:B,positionSource:s.creator?"clmm":"farming",farmsPoolId:s.id,coinA:m.coinA,coinB:m.coinB,soucrce:s.id?"farming":"clmm",positionShare:I,amountAUsd:O,amountBUsd:y,amountA:M,amountB:T})}this.farmsPositionList=i;const a={};i.forEach(r=>{a[r.clmm_pool_id||r.pool]||(a[r.clmm_pool_id||r.pool]=[]),a[r.clmm_pool_id||r.pool].push(r)}),this.farmsPositionObj=a,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),this.getMyFarms()},getMyFarms(){const g=[];this.farmsPoolList.forEach(n=>{console.log(this.farmsPositionObj[n.clmm_pool_id],"this.this.farmsPositionObj[##");const e=this.farmsPositionObj[n.clmm_pool_id]&&this.farmsPositionObj[n.clmm_pool_id].filter(u=>u.positionSource=="farming");console.log(e,"getMyFarmsresult##"),e&&e.length>0&&g.push(n)}),this.myFarmsPoolList=g,console.log(g,"##myFarms")}}});export{V as u};
