import{a7 as Q}from"./entry.860c92d6.js";import{u as V,T as X,e as z,m as H}from"./pool.2ce9a355.js";import{D as c}from"./decimal.0bdeb344.js";import{c as W}from"./sha256.8ff50915.js";const to=Q("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},totalRwadrdUsd:"",farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return V()}},actions:{async getFarmsPoolList(){this.farmsPoolListLoading=!0;try{const{data:S}=await fetch(`${W.Sui.api}/v2/sui/swap/count`).then(p=>p.json()),m=S.pools.filter(p=>p.stable_farming.stable_farming_pool);let d=0;const u=m.map(p=>{console.log(p,"#farmsPool");const b=p.stable_farming,g=poolInfo.coinA.decimals,s=poolInfo.coinB.decimals,r=X.tickIndexToPrice(p.effective_tick_lower,g,s).toString(),a=X.tickIndexToPrice(p.effective_tick_upper,g,s).toString(),e=b.stable_rewarder.map(l=>(d+=l.amount_second,{emission_per_day:new c(l.amount_second).mul(60*60*24),reward_coin:l.coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":l.coin,symbol:l.symbol,allocate_point:l.amount_second>0?1:0}));return{clmm_pool_id:p.swap_account,effective_tick_lower:b.effective_tick_lower,effective_tick_upper:b.effective_tick_upper,fee:p.fee*100+"%",id:b.stable_farming_pool,rewarders:e,status:d>0?"Live":"Ended"}});console.log(m,u,"farmsPools####")}catch{const d=await z("Sui").getLpList(),u=Object.fromEntries(d.map((s,r)=>[s.address,s]));console.log(u,"cmmLpObj##");const b=await H("Sui").getFramsPoolList();console.log("getFarmsPoolList:",b);const g=b.map(s=>{const r=u[s.clmm_pool_id];let a=0;const{tokensObj:e}=this.getPoolStore,l=s.rewarders.map(n=>{const o=n.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":n.reward_coin,f=e[o].decimals,L=e[o].symbol;a=a+Number(n.allocate_point);const _=new c(n.allocate_point).div(new c(n.total_allocate_point));return{...n,reward_coin:o,emission_per_day:Number(n.allocate_point)>0?new c(n.emission_per_second).mul(_).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,f)).toString():"0",symbol:L}}),P=r.coinA.decimals,w=r.coinB.decimals,i=X.tickIndexToPrice(s.effective_tick_lower,P,w).toString(),t=X.tickIndexToPrice(s.effective_tick_upper,P,w).toString();return console.log(a,"allocatePoint##"),{...s,minPrice:i,maxPrice:t,fee:r.fee*100+"%",coinA:r.coinA,coinB:r.coinB,rewarders:l,status:a>0?"Live":"Ended"}});console.log("getFarmsPoolList",g),this.farmsPoolList=g,this.farmsPoolObj=Object.fromEntries(g.map(s=>[s.clmm_pool_id,{...s,address:s.clmm_pool_id}])),this.cmmPoolInfoObj=u,this.farmsPoolListLoading=!1}},async getPositionByPool(S,m,d){var i,t;this.farmsLoadingObj[m]=!0;const u=z("Sui"),p=H("Sui");console.log(S,m,"#account, poolAddress");const g=(await p.getOwnedFramsPositionNFTList(!0)).filter(n=>n.clmm_pool_id==m),s=await u.getPositionList(S,{address:{address:m}})||[],r=g.concat(s);console.log(g,s,"###farmingPositionList"),console.log(r,"###positionGroup");const a={},e={},l=[];for(let n=0;n<r.length;n++){const o=r[n],f=this.cmmPoolInfoObj[o.clmm_pool_id||o.pool];console.log(f,"##poolInfo");const L=f.coinA.decimals,_=f.coinB.decimals;let R,x;o.tick_lower_index==u.TickUtil.getMinIndex(Number(f.tick_spacing))?R="0":R=u.TickMath.tickIndexToPrice(Number(o.tick_lower_index),L,_).toString(),o.tick_upper_index==u.TickUtil.getMaxIndex(Number(f.tick_spacing))?x="∞":x=u.TickMath.tickIndexToPrice(Number(o.tick_upper_index),L,_).toString(),console.log(o,"#position.clmm_pool_id");let j;const I=await u.getPool(o.clmm_pool_id||o.pool),F=X.sqrtPriceX64ToPrice(I.current_sqrt_price,L,_).toString();Number(F)>=Number(R)&&(x==="∞"||Number(F)<=Number(x))?j="Active":(Number(F)>Number(x)||Number(F)<Number(R))&&(j="Inactive");const E=u.getCoinAmountFromLiquidity({pool:I,position:o,roundUp:!1}),{RATES:N,tokensObj:q}=this.getPoolStore;console.log(N,"##cmmPoolStore");const B=((i=N[f.coinA.address])==null?void 0:i.price)||"",v=((t=N[f.coinB.address])==null?void 0:t.price)||"",C=new c(E.coinaAmount).div(Math.pow(10,L)),y=new c(E.coinbAmount).div(Math.pow(10,_)),T=new c(E.coinaAmount).div(Math.pow(10,L)).mul(B),M=new c(E.coinbAmount).div(Math.pow(10,_)).mul(v);let U=new c(0);o.rewards&&o.rewards.length>0?o.rewards=o.rewards.map(h=>{var J;console.log(h,o,"reward##171");const k=h.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":h.rewarder_type,$=q[k];console.log(q,"##tokensObj");const A=((J=N[k])==null?void 0:J.price)||0,D=new c(h.rewarder_amount).div(new c(Math.pow(10,$.decimals)));console.log(D,A,"amount,rewardPrice");const G=D.mul(new c(A));return console.log(G.toString(),"rewarderAmountUsd"),e[o.clmm_pool_id]&&e[o.clmm_pool_id][o.id]?e[o.clmm_pool_id][o.id]=e[o.clmm_pool_id][o.id].add(G):e[o.clmm_pool_id]&&!e[o.clmm_pool_id][o.id]?(e[o.clmm_pool_id][o.id]={},e[o.clmm_pool_id][o.id]=G):(e[o.clmm_pool_id]={},e[o.clmm_pool_id][o.id]={},e[o.clmm_pool_id][o.id]=G),console.log(this.farmsRewardObj,"##farmsRewardObj"),U=U.add(G),{...h,rewarderAmount:D.toString(),rewarderAmountUsd:G.toString(),rewarderType:k}}):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let O;if(o.id){const h=T.add(M);a[o.clmm_pool_id]||(a[o.clmm_pool_id]={}),a[o.clmm_pool_id][o.id]=h,console.log(o,"potision###");const k=this.farmsPoolObj[o.clmm_pool_id];O=p.calculatePositionShare(o,k,I.current_sqrt_price),console.log(O,"##positionShare")}console.log(this.farmsUserUsd,"##this.farmsUserUsd"),l.push({...o,minPrice:R,maxPrice:x,positionUSD:T.add(M).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:j,positionSource:o.creator?"clmm":"farming",farmsPoolId:d,coinA:f.coinA,coinB:f.coinB,positionShare:O,amountAUsd:T,amountBUsd:M,amountA:C,amountB:y,positionRewardAmount:U})}const P={};Object.keys(e).forEach(n=>{P[n]={},P[n].amountUsd=new c(0),typeof e[n]=="object"&&Object.keys(e[n]).forEach(o=>{console.log(o,e[n][o],"#######375"),P[n].amountUsd=P[n].amountUsd.add(e[n][o])})});const w={};Object.keys(a).forEach(n=>{w[n]={},w[n].amount=new c(0),w[n].positionNum=0,typeof a[n]=="object"&&Object.keys(a[n]).forEach(o=>{w[n].amount=w[n].amount.add(a[n][o]),w[n].positionNum+=1})}),console.log("farmsUserUsd:",a),console.log(P,"##farmsRewardObjResult"),this.farmsRewardObj={...this.farmsRewardObj,...P},this.farmsUserUsd={...this.farmsUserUsd,...w},this.farmsPositionObj[m]=l,this.farmsLoadingObj[m]=!1},async getPositionByAllPool(S){var P,w;this.farmsAllPositionLoading=!0;const m=H("Sui"),d=z("Sui");this.totalRwadrdUsd=0;const u=await m.getOwnedFramsPositionNFTList(!0),p=await d.getPositionList(S,this.farmsPoolObj)||[];console.log(p,"###clmmPositionList");const b=u.concat(p);console.log(b,"##positionGroup");const g=[],s={},r={};for(let i=0;i<b.length;i++){const t=b[i],n=await d.getPool(t.clmm_pool_id||t.pool),o=d.getCoinAmountFromLiquidity({pool:n,position:t,roundUp:!1}),{RATES:f,tokensObj:L}=this.getPoolStore,_=this.cmmPoolInfoObj[t.clmm_pool_id||t.pool],R=((P=f[_.coinA.address])==null?void 0:P.price)||"",x=((w=f[_.coinB.address])==null?void 0:w.price)||"",j=_.coinA.decimals,I=_.coinB.decimals,F=new c(o.coinaAmount).div(Math.pow(10,j)),E=new c(o.coinbAmount).div(Math.pow(10,I)),N=new c(o.coinaAmount).div(Math.pow(10,j)).mul(R),q=new c(o.coinbAmount).div(Math.pow(10,I)).mul(x);let B,v;t.tick_lower_index==d.TickUtil.getMinIndex(Number(_.tick_spacing))?B="0":B=d.TickMath.tickIndexToPrice(Number(t.tick_lower_index),j,I).toString(),t.tick_upper_index==d.TickUtil.getMaxIndex(Number(_.tick_spacing))?v="∞":v=d.TickMath.tickIndexToPrice(Number(t.tick_upper_index),j,I).toString();let C;const y=X.sqrtPriceX64ToPrice(n.current_sqrt_price,j,I).toString();Number(y)>=Number(B)&&(v==="∞"||Number(y)<=Number(v))?C="Active":(Number(y)>Number(v)||Number(y)<Number(B))&&(C="Inactive");let T;if(t.id){const U=N.add(q);r[t.clmm_pool_id]||(r[t.clmm_pool_id]={}),r[t.clmm_pool_id][t.id]=U,console.log(t,"potision###");const O=this.farmsPoolObj[t.clmm_pool_id];T=m.calculatePositionShare(t,O,n.current_sqrt_price),console.log(T,"##positionShare")}let M=new c(0);t.rewards&&t.rewards.length>0&&(t.rewards=t.rewards.map(U=>{var D;console.log(U,t,"#reward292");const O=U.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":U.rewarder_type,h=L[O];console.log(h,O,"tokenInfo##294");const k=((D=f[O])==null?void 0:D.price)||0,$=new c(U.rewarder_amount).div(new c(Math.pow(10,h==null?void 0:h.decimals))),A=$.mul(new c(k));return console.log(A,"##rewarderAmountUsd"),s[t.clmm_pool_id]&&s[t.clmm_pool_id][t.id]?s[t.clmm_pool_id][t.id]=s[t.clmm_pool_id][t.id].add(A):s[t.clmm_pool_id]&&!s[t.clmm_pool_id][t.id]?(s[t.clmm_pool_id][t.id]={},s[t.clmm_pool_id][t.id]=A):(s[t.clmm_pool_id]={},s[t.clmm_pool_id][t.id]={},s[t.clmm_pool_id][t.id]=A),this.totalRwadrdUsd=new c(this.totalRwadrdUsd).add(A),M=M.add(A),{...U,rewarderAmount:$.toString(),rewarderAmountUsd:A.toString(),rewarderType:O}})),console.log(t.rewards,"position.rewards:"),g.push({...t,minPrice:B,maxPrice:v,positionUSD:N.add(q).toNumber(),clmmPool:t.clmm_pool_id||t.pool,positionStatus:C,positionSource:t.creator?"clmm":"farming",farmsPoolId:t.pool_id,coinA:_.coinA,coinB:_.coinB,soucrce:t.id?"farming":"clmm",positionShare:T,amountAUsd:N.toString(),amountBUsd:q.toString(),amountA:F.toString(),amountB:E.toString(),positionRewardAmount:M})}this.farmsPositionList=g;const a={};g.forEach(i=>{a[i.clmm_pool_id||i.pool]||(a[i.clmm_pool_id||i.pool]=[]),a[i.clmm_pool_id||i.pool].push(i)}),this.farmsPositionObj=a,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),console.log(s,"##this.farmsRewardObj");const e={};Object.keys(s).forEach(i=>{console.log(s,i,"farmsRewardObj:"),e[i]={},e[i].amountUsd=new c(0),typeof s[i]=="object"&&Object.keys(s[i]).forEach(t=>{console.log(s[i][t].toString(),"#######375"),e[i].amountUsd=e[i].amountUsd.add(s[i][t]),console.log(e[i].amountUsd.toString(),"result[key].amountUsd.toString()")})});const l={};Object.keys(r).forEach(i=>{l[i]={},l[i].amount=new c(0),l[i].positionNum=0,typeof r[i]=="object"&&Object.keys(r[i]).forEach(t=>{l[i].amount=l[i].amount.add(r[i][t]),l[i].positionNum+=1})}),console.log("farmsUserUsd:",r),console.log(this.totalRwadrdUsd,"this.totalRwadrdUsd###"),this.farmsRewardObj=e,this.farmsUserUsd=l,console.log(this.farmsRewardObj,"##this.farmsRewardObj"),this.getMyFarms()},getMyFarms(){const S=[];this.farmsPoolList.forEach(m=>{console.log(this.farmsPositionObj[m.clmm_pool_id],"this.this.farmsPositionObj[##");const d=this.farmsPositionObj[m.clmm_pool_id]&&this.farmsPositionObj[m.clmm_pool_id].filter(u=>u.positionSource=="farming");console.log(d,"getMyFarmsresult##"),d&&d.length>0&&S.push(m)}),this.myFarmsPoolList=S,console.log(S,"##myFarms")},logOut(){this.farmsPositionObj={},this.farmsUserUsd={},this.farmsRewardObj={},this.totalRwadrdUsd="",this.farmsPositionList=[],this.farmsAllPositionLoading=!1,this.myFarmsPoolList=[]}}});export{to as u};
